(()=>{"use strict";const e=()=>`${(new Date).toISOString().slice(11,23)} (TS)`;let t=!0;function n(...t){console.log.apply(console,[`${e()} |`,...t])}function o(...t){console.info.apply(console,[`${e()} |`,...t])}function a(...t){console.debug.apply(console,[`${e()} |`,...t])}function l(...e){}const r=()=>{t?window.location.reload():o("Page reload was triggered and blocked due to PlaceholderPlugin.debug_disable_reload")},s={log:l,info:l,debug:l};let i=s;const c=()=>{o("Page reload was disabled for debugging purposes"),t=!1};var d,u;!function(e){e.Warning="WARNING",e.Error="ERROR"}(d||(d={})),function(e){e.Good="GOOD",e.Warning="WARNING",e.Error="ERROR",e.NoValidator="NO_VALIDATOR"}(u||(u={}));const p=e=>{const t=Te("rules","object",e);if(0==t.length)throw new Error(`Rules should not be an empty array.\nProblematic object: ${JSON.stringify(e)}`);const n=ke("id",e);return{display_name:ke("display_name",e),id:n,rules:t.map((e=>w(e,n)))}},h=(e,t)=>{for(const n of e.rules)if(n.is_match_function(t)!=n.should_match&&n.severity==d.Error)return!1;return!0},f=(e,t)=>{if(e.validators.length>0){for(const n of e.validators)if(h(n,t))return!0;return!1}return!0},_=(e,t)=>{const n=[],o=[];for(const a of e.rules)a.is_match_function(t)!=a.should_match&&(a.severity==d.Error?o.push(`[${e.display_name}] Error: ${a.error_message}`):a.severity==d.Warning?n.push(`[${e.display_name}] Warning: ${a.error_message}`):console.warn(`Unknown rule severity ${a.severity}`));return{errors:o,warnings:n}},g=(e,t)=>{const n=[];let o=!1;if(e.validators.length>0){for(const a of e.validators){const l=_(a,t);if(n.push(l),0==l.errors.length&&(o=!0,0==l.warnings.length))return b(e)}return o?v(n):m(n)}return{rating:u.NoValidator,message:"No validators are specified for this placeholder"}},m=e=>{const t=[];for(const n of e)t.push(...n.errors);return{rating:u.Error,message:t.join("\n")}},v=e=>{const t=[];for(const n of e)0==n.errors.length&&t.push(...n.warnings);return{rating:u.Warning,message:t.join("\n")}},b=e=>{let t;if(1==e.validators.length)t=`Expecting: ${e.validators[0].display_name}`;else{t="Expecting one of the following: ";for(const n of e.validators)t+=`\n - ${n.display_name}`}return{rating:u.Good,message:t}},w=(e,t)=>{const n=ke("severity",e);let o,a;if("warning"==n||"warn"==n)o=d.Warning;else{if("error"!=n)throw new Error(`Unknown severity '${n}'`);o=d.Error}if(e.regex){const t=ke("regex",e),n=new RegExp(t);a=e=>n.test(e)}else{const n=ke("match_function",e),o=new Function("value",n);a=e=>{try{const a=o(e);if("boolean"!=typeof a)throw new Error(`Custom match_function '${n}' of validator ${t} should return a boolean, but it returned a ${typeof a}: ${a}`);return a}catch(e){throw new Error(`Failed to evaluate match_function '${n}' of validator ${t}: ${e}`)}}}return{severity:o,should_match:Ee("should_match",e),error_message:ke("error_message",e),is_match_function:a}},x=(e,t)=>{e.classList.remove("validation-error","validation-warn","validation-ok","validation-none"),t.rating==u.Good?e.classList.add("validation-ok"):t.rating==u.Warning?e.classList.add("validation-warn"):t.rating==u.Error?e.classList.add("validation-error"):t.rating==u.NoValidator?e.classList.add("validation-none"):console.warn(`Unknown placeholder validity: ${t.rating}`),e.title=t.message},y=(e,t)=>{const n=g(e,t.value);return x(t,n),i.debug("Validation: name =",e.name,", value =",t.value,", results =",n.rating),n.rating!=u.Error},$=(e,t)=>{const n=g(e,t.innerText);return x(t,n),i.debug("Validation: name =",e.name,", value =",t.innerText,", results =",n.rating),n.rating!=u.Error},k="PLACEHOLDER_",E="PLACEHOLDER-SETTING_",L=(e,t)=>{localStorage.setItem(k+e,t)},T=e=>localStorage.getItem(k+e),C=(e,t)=>{const n=localStorage.getItem(`${E}${e}`);return i.info(`Reading boolean setting '${e}' with value ${n}`),null===n?t:"1"===n||"0"!==n&&(console.warn(`Unexpected state for boolean setting. Should be null, '0' or '1', but was '${n}'`),t)},N=(e,t)=>{e.current_is_checked=t,e.current_value=t?e.value_checked:e.value_unchecked,L(`${e.name}_IS_CHECKED`,t?"1":"0")},D=()=>{A(k)},S=()=>{A(E)},A=e=>{console.warn(`Clearing all localStorage items starting with '${e}'`);let t=0;for(;t<localStorage.length;){const n=localStorage.key(t);(null==n?void 0:n.startsWith(e))?localStorage.removeItem(n):t++}r()},R=(e,t)=>{try{const n=e.options[t];return null!=n&&null!=n}catch(e){return!1}},P=(e,t)=>{if(!R(e,t))throw new Error(`Index must a whole number N, where 0 <= N < ${e.options.length}. But it is ${t}`);L(`${e.name}_INDEX`,`${t}`),e.current_value=e.options[t].value,e.current_index=t},I=(e,t)=>{const n=f(e,t);if(i.info(`Set textbox ${e.name} to '${t}'. Validation ok? ${n}`),!n)throw new Error(`Validation error: Value '${t}' is not valid for placeholder ${e.name}`);L(`${e.name}_TEXT`,t)},H=(e,t,n)=>{t.classList.add("placeholder-value-dropdown"),t.querySelectorAll(".inline-editor-icon-span").forEach((e=>{e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21,9L17,5V8H10V10H17V13M7,11L3,15L7,19V16H14V14H7V11Z" /></svg>'})),t.setAttribute("tabindex","0");const o={signal:e.event_listener_abort_controller.signal},a=n.description?`\nDescription: ${n.description}`:"";let l=`Placeholder name: ${n.name}${a}\nDefault option: ${n.options[n.default_index].value}\nUsage: (left-)click to cycle forward through the values, right-click to cycle through backwards. You can also use the Enter, Up, and Down keys if the placeholder is selected.\nPossible values:`;for(const e of n.options)l+=`\n- ${e.value}`;t.title=l;const r=t=>{let o=(n.current_index+t)%n.options.length;o<0&&(o+=n.options.length),P(n,o),n.current_index=o,n.current_value=n.options[o].value,te(e,n)};t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),r(1)}),o),t.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),r(-1)}),o),t.addEventListener("keydown",(e=>{"Enter"===e.key||"ArrowDown"===e.key?(r(1),e.preventDefault()):"ArrowUp"===e.key&&(r(-1),e.preventDefault())}),o)},V=(e,t,n)=>{t.tabIndex=0,t.spellcheck=!1,t.translate=!1,t.autocapitalize="off",t.classList.add("placeholder-value-editable"),t.querySelectorAll(".inline-editor-icon-span").forEach((e=>{e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>'}));const o={signal:e.event_listener_abort_controller.signal},a=()=>{n.current_value==t.innerText?i.debug(`Value for placeholder ${n.name} was not changed`):$(n,t)&&(I(n,t.innerText),n.current_value=t.innerText,te(e,n),t.classList.remove("value-modified"))};$(n,t),t.title=n.default_tooltip,t.addEventListener("input",(()=>{$(n,t),t.innerText==n.current_value?t.classList.remove("value-modified"):t.classList.add("value-modified")}),o),t.addEventListener("keypress",(e=>{"Enter"===e.key&&(e.preventDefault(),i.debug("Textbox change confirmed with Enter key for",n.name,"- new value:",t.innerText),a(),M(t))}),o),t.addEventListener("keydown",(e=>{"Escape"===e.key&&(i.debug("Resetting input field for ",n.name," to current placeholder value"),be(t,n.current_value),$(n,t),t.classList.remove("value-modified"),M(t))}),o),t.addEventListener("focusout",(()=>{var o;i.debug("Focus lost"),e.settings.apply_change_on_focus_change&&(i.debug("Textbox change confirmed by changing focus",n.name,"- new value:",t.innerText),a());const l=g(n,t.innerText);if(l.rating==u.Good||l.rating==u.NoValidator)for(const e of n.output_elements)e.classList.contains("placeholder-value-editable")&&(e.title=n.default_tooltip);t.contentEditable="false",null===(o=window.getSelection())||void 0===o||o.removeAllRanges()}),o),t.addEventListener("focusin",(()=>{i.debug("Focus gained");try{t.contentEditable="plaintext-only"}catch(e){t.contentEditable="true"}$(n,t),setTimeout((()=>M(t)),50)}),o)};let O=!1;const M=e=>{if(window.getSelection&&document.createRange){const t=window.getSelection();if(t){t.removeAllRanges();const n=document.createRange();n.selectNodeContents(e.firstChild||e),t.addRange(n)}else O||(O=!0,console.warn("getSelection returned null"))}else O||(O=!0,console.warn("Can not set selection, because window.getSelection or document.createRange are not supported"))},U=e=>{j(e.settings.inline_editor_icons);const t=document.querySelectorAll("span.placeholder-value.inline-editor-requested[data-placeholder]");for(const n of t){const t=n.getAttribute("data-placeholder");if(t){const o=e.placeholders.get(t);if(o){if(!o.read_only){n.classList.add("placeholder-value-any");const t=document.createElement("span");t.classList.add("inline-editor-icon-span"),t.contentEditable="false",n.appendChild(t),o.type==Ne.Textbox?V(e,n,o):o.type==Ne.Checkbox?oe(e,n,o):o.type==Ne.Dropdown&&H(e,n,o)}}else console.warn(`Unknown placeholder referenced in input element: '${t}'`,n)}}},j=e=>{e?(document.body.classList.add("inline-editor-icons"),document.body.classList.remove("inline-editor-simple")):(document.body.classList.add("inline-editor-simple"),document.body.classList.remove("inline-editor-icons"))},W=new Map;W.set("name","Name"),W.set("description","Description"),W.set("value","Value"),W.set("input","Input element"),W.set("description-or-name","Description / name");const q=(e,t)=>{e.appendChild(document.createTextNode(t))},z=(e,t)=>{const n=document.createElement(t);return e.appendChild(n),n},B=(e,t,n)=>{const o=t=>{for(const n of e.placeholders.values())for(const e of n.output_elements)t?e.classList.add("placeholder-value-highlighted"):e.classList.remove("placeholder-value-highlighted")};o(e.settings.highlight_placeholders),n&&(z(t,"b").textContent="Settings");const a=e=>{};F(t,e.settings.expand_auto_tables,"expand_auto_tables","Expand placeholder tables by default*",a),F(t,e.settings.apply_change_on_focus_change,"apply_change_on_focus_change","Apply value when focus changes away*",a),F(t,e.settings.debug,"debug","Log JavaScript debug messages to console*",a),F(t,e.settings.highlight_placeholders,"highlight_placeholders","Highlight placeholders (useful for debugging)",o),F(t,e.settings.inline_editors,"inline_editors","Allow editing placeholders directly in the page",(t=>{t?U(e):(e=>{const t=document.querySelectorAll("span.placeholder-value-editable, span.placeholder-value-checkbox, span.placeholder-value-dropdown");e.event_listener_abort_controller.abort(),e.event_listener_abort_controller=new AbortController;for(const e of t){const t=e;t.classList.remove("placeholder-value-editable","placeholder-value-checkbox","placeholder-value-dropdown","placeholder-value-any","validation-error","validation-warn","validation-ok","validation-none"),t.contentEditable="false",t.title="",t.removeAttribute("tabindex"),t.querySelectorAll(".inline-editor-icon-span").forEach((e=>e.remove()))}})(e)})),F(t,e.settings.inline_editor_icons,"inline_editor_icons","Use icons and other styling to highlight inline editors",j),z(t,"i").textContent="* You need to reload the page for these settings to take effect.";const l=z(t,"div");l.classList.add("button-bar");const r=z(l,"button");r.textContent="Reset settings",r.addEventListener("click",S);const s=z(l,"button");s.textContent="Reset all placeholders",s.addEventListener("click",D)},F=(e,t,n,o,a)=>{const l=z(e,"label");l.textContent=`${o} `;const r=z(l,"input");r.type="checkbox",r.checked=t,r.addEventListener("change",(()=>{((e,t)=>{i.info(`Storing boolean setting '${e}' with value ${t}`),localStorage.setItem(`${E}${e}`,t?"1":"0")})(n,r.checked),a(r.checked)}))},J=(e,t,n,o,a)=>{o=X(o);const l=document.createElement("div");if(0==o.length){if(!a)return void e.remove();l.textContent="No placeholders to be shown"}else{i.info("Creating automatic input table at",e,"with columns",t),l.classList.add("table-div"),z(l,"b").innerHTML="Enter different values in the table below and press <code>Enter</code> to update this page.";const a=z(l,"table"),r=z(a,"thead"),s=z(r,"tr"),c=z(a,"tbody");for(const e of t){const t=z(s,"th"),n=W.get(e);n?q(t,n):(q(t,e),console.error(`Unknown column name: ${e}`))}const d=[];for(const e of o){if(e.read_only){i.debug(`auto_table: Skipping ${e.name} because it is read-only`);continue}const o=z(c,"tr");G(o,e,t,n),d.push({element:o,placeholder:e})}n.input_tables.push({columns:t,table_element:a,rows:d})}((e,t,n)=>{t.innerHTML="";const o=z(t,"div"),a=z(o,"div"),l=z(o,"div"),r=z(t,"div"),s=z(r,"div");r.append(n);const i=e=>{r.style.display=e?"flex":"none",a.textContent="Placeholders: Click here to "+(e?"collapse":"expand")};o.classList.add("auto-table-title"),r.classList.add("expandable_contents"),s.classList.add("settings_contents");let c=e.settings.expand_auto_tables;i(c),a.addEventListener("click",(()=>{c=!c,i(c)})),a.classList.add("text"),((e,t,n)=>{let o=!1;e.onclick=e=>{e.preventDefault(),e.stopPropagation(),o=!o,t.style.display=o?"flex":"none",o&&n()},t.style.display=o?"flex":"none",e.classList.add("settings_button"),e.innerHTML='<svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">\n <path id="svg_6" d="m7.79338,20.02127l0,0c0,-6.84327 5.74307,-12.39083 12.82751,-12.39083l0,0c3.40207,0 6.6648,1.30546 9.07042,3.62919c2.40563,2.32373 3.75709,5.47539 3.75709,8.76164l0,0c0,6.84327 -5.74307,12.39083 -12.82751,12.39083l0,0c-7.08444,0 -12.82751,-5.54757 -12.82751,-12.39083zm6.41376,0l0,0c0,3.42163 2.87154,6.19542 6.41376,6.19542c3.54222,0 6.41376,-2.77378 6.41376,-6.19542c0,-3.42163 -2.87154,-6.19542 -6.41376,-6.19542l0,0c-3.54222,0 -6.41376,2.77378 -6.41376,6.19542z" stroke="#fff" fill="#ffffff"/>\n <path id="svg_7" d="m17.46095,7.63098l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n <path transform="rotate(180, 20.9544, 35.1419)" id="svg_11" d="m17.57012,37.76199l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n <path transform="rotate(43, 31.5439, 9.59605)" id="svg_12" d="m28.15964,12.21614l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n <path transform="rotate(90, 35.9107, 19.8581)" id="svg_13" d="m32.52645,22.47815l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n <path transform="rotate(135, 31.7623, 30.2292)" id="svg_14" d="m28.37798,32.84933l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n <path transform="rotate(-45, 9.49152, 9.48688)" id="svg_15" d="m6.10724,12.10697l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n <path transform="rotate(-90, 5.01553, 19.9672)" id="svg_16" d="m1.63126,22.58732l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n <path transform="rotate(-135, 9.60069, 30.7751)" id="svg_17" d="m6.21641,33.39518l1.2691,-5.24017l4.23035,0l1.2691,5.24017l-6.76856,0z" stroke="#fff" fill="#ffffff"/>\n</svg>',e.title="Hide / show settings"})(l,s,(()=>{c||(c=!0,i(c))})),B(e,s,!0)})(n,e,l)},X=e=>[...new Set(e)].sort(((e,t)=>e.order_index-t.order_index)),G=(e,t,n,o)=>{for(const a of n){const n=z(e,"td");if("name"==a)q(n,t.name);else if("description"==a)q(n,t.description);else if("value"==a){const e=se(t);n.appendChild(e),t.output_elements.push(e)}else if("input"==a){const e=z(n,"input");Z(o,t,e)}else if("description-or-name"==a){const e=t.description||t.name;q(n,e)}else console.error(`Unknown column name: ${a}`)}},Y=(e,t,n)=>{n=X(n);const o=[];for(const e of t.rows)n.includes(e.placeholder)?o.push(e):(i.debug(`Removed table row for ${e.placeholder.name}:`,e.element),e.element.remove());const a=[],l=[...o].reverse(),r=[...n].reverse();let s;for(;s=r.pop();){const n=l.slice(-1)[0];if(n&&n.placeholder===s)l.pop(),a.push(n);else{const n=document.createElement("tr");0==a.length?t.table_element.insertBefore(n,t.table_element.firstChild):a[a.length-1].element.insertAdjacentElement("afterend",n),G(n,s,t.columns,e),a.push({element:n,placeholder:s}),i.debug(`Added table row for ${s.name}:`,n)}}t.rows=a},Z=(e,t,n)=>{n.classList.add("input-for-variable"),t.type==Ne.Checkbox?K(e,t,n):t.type==Ne.Dropdown?Q(e,t,n):t.type==Ne.Textbox?ee(e,t,n):console.error(`Placeholder ${t.name} has unknown type '${t.type}'`)},K=(e,t,n)=>{"INPUT"==n.tagName?(n.type="checkbox",n.checked=t.current_is_checked,t.read_only?n.disabled=!0:(n.disabled=!1,n.addEventListener("change",(()=>{i.debug("Checkbox change",t.name,"- new value:",n.checked),N(t,n.checked),t.current_value=n.checked?t.value_checked:t.value_unchecked,te(e,t)}))),t.input_elements.push(n)):console.warn(`Input element/tag for placeholder '${t.name}' is expected to be INPUT, but is ${n.tagName}. Skipping`,n)},Q=(e,t,n)=>{const o=document.createElement("select");o.classList.add("placeholder-dropdown");for(const e of t.options){const t=document.createElement("option");t.text=e.display_name,o.appendChild(t)}n.parentNode?n.parentNode.replaceChild(o,n):console.error("Input element",n,`for placeholder ${t.name} has no parent!`),o.selectedIndex=t.current_index,t.read_only?o.disabled=!0:(o.disabled=!1,o.addEventListener("change",(()=>{i.debug("Dropdown change",t.name,"- new index:",o.selectedIndex),P(t,o.selectedIndex),t.current_index=o.selectedIndex,t.current_value=t.options[o.selectedIndex].value,te(e,t)}))),t.input_elements.push(o)},ee=(e,t,n)=>{if("INPUT"==n.tagName){if(n.value=t.current_value,t.read_only)n.disabled=!0,n.style.cursor="not-allowed";else{n.disabled=!1,null!=t.default_value?n.placeholder=`Default: ${t.default_value}`:n.placeholder="Dynamic default value";const o=()=>{t.current_value==n.value?i.debug(`Value for placeholder ${t.name} was not changed`):y(t,n)&&(I(t,n.value),t.current_value=n.value,te(e,t),n.classList.remove("value-modified"))};y(t,n),n.addEventListener("input",(()=>{y(t,n),n.value==t.current_value?n.classList.remove("value-modified"):n.classList.add("value-modified")})),n.addEventListener("keypress",(e=>{"Enter"===e.key&&(i.debug("Textbox change confirmed with Enter key for",t.name,"- new value:",n.value),o())})),n.addEventListener("keydown",(e=>{"Escape"===e.key&&(i.debug("Resetting input field for ",t.name," to current placeholder value"),n.value=t.current_value,y(t,n),n.classList.remove("value-modified"))})),n.addEventListener("focusout",(()=>{e.settings.apply_change_on_focus_change&&(i.debug("Textbox change confirmed by changing focus",t.name,"- new value:",n.value),o())}))}t.input_elements.push(n)}else console.warn(`Input element/tag for placeholder '${t.name}' is expected to be INPUT, but is ${n.tagName}. Skipping`,n)},te=(e,t)=>{const n=e.dependency_graph.get_all_upstream(t);let o=!1;for(const e of n)o=o||e.reload_page_on_change;if(i.debug(`Change of ${t.name} requires updates for placeholders:\n${n.map((e=>` - ${e.name}\n`)).join("")}\nRequires reload: ${o}`),o)r();else{if(e.dependency_graph.on_placeholder_value_change(t),(e=>{if(i.debug(`Updating ${e.input_tables.length} automatic input tables`),e.input_tables.length>0){const t=e.dependency_graph.get_all_used_placeholders();for(const n of e.input_tables)Y(e,n,t)}})(e),t.type==Ne.Checkbox){const e=t;for(const t of e.input_elements)t.checked=e.current_is_checked}else if(t.type==Ne.Dropdown){const e=t;for(const t of e.input_elements)t.selectedIndex=e.current_index}else if(t.type==Ne.Textbox){const e=t;for(const t of e.input_elements)t.value=e.current_value,y(e,t)}else console.warn(`Placeholder ${t.name} has unexpected type '${t.type}'`);ve(n)}},ne=(e,t)=>{t.current_is_checked?(e.classList.add("checked"),e.classList.remove("unchecked")):(e.classList.add("unchecked"),e.classList.remove("checked"))},oe=(e,t,n)=>{t.classList.add("placeholder-value-checkbox"),t.querySelectorAll(".inline-editor-icon-span").forEach((e=>{e.innerHTML='<svg class="checkbox-checked" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,5V19H5V5H19M10,17L6,13L7.41,11.58L10,14.17L16.59,7.58L18,9" /></svg><svg class="checkbox-unchecked" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z" /></svg>'})),t.setAttribute("tabindex","0");const o={signal:e.event_listener_abort_controller.signal},a=n.description?`\nDescription: ${n.description}`:"";t.title=`Placeholder name: ${n.name}${a}\nUsage: Click to toggle the value. You can also press Enter if the placeholder is focused.`;const l=()=>{const t=!n.current_is_checked;n.current_value=t?n.value_checked:n.value_unchecked,i.debug("Checkbox change",n.name,"- new value:",t),N(n,t),te(e,n)};t.addEventListener("click",l,o),t.addEventListener("keydown",(e=>{"Enter"===e.key&&(l(),e.preventDefault())}),o),ne(t,n)},ae=(e,t,n)=>{const o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let a,l=0;for(t.global||console.warn(`You should set the global flag for the regex. Context: replacing '${t.source}' with '${n}'`);a=o.nextNode();)if(a.nodeValue){const e=a.nodeValue.replace(t,n);a.nodeValue!=e&&(a.nodeValue=e,l++)}return l},le=e=>{const t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML},re=(e,t,n)=>{n=le(n),t.global||console.warn(`You should set the global flag for the regex. Context: replacing '${t.source}' with '${n}'`);const o=e.innerHTML.replace(t,n);return o!=e.innerHTML?(e.innerHTML=o,1):0},se=e=>{const t=document.createElement("span");return t.classList.add("placeholder-value"),t.dataset.placeholder=e.name,t.textContent=e.expanded_value,t},ie=(e,t,n,o)=>de(e,t,n,o,"placeholder-value-static"),ce=(e,t,n,o)=>de(e,t,n,o,"inline-editor-requested"),de=(e,t,n,o,a)=>{var l;const r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let s;t.global||console.warn(`You should set the global flag for the regex. Context: replacing '${t.source}' with '${n.current_value}'`);let c=0;if(o){const e=a?`.${a}`:"",t=document.querySelectorAll(`${e}.placeholder-value[data-placeholder]`);for(const e of t)e.getAttribute("data-placeholder")===n.name&&c++;if(c>0){const e=a?"editable":"dynamic";i.debug(`${c} ${e} placeholder elements already exist for placeholder ${n.name}`)}}const d=[];for(;s=r.nextNode();)s.nodeValue&&s.nodeValue.match(t)&&d.push(s);if(d){const e=`<span class="placeholder-value${a?` ${a}`:""}" data-placeholder="${le(n.name)}">TEMPORARY PLACEHOLDER</span>`;for(const n of d)if(n.nodeValue){const o=le(n.nodeValue).replace(t,e),a=document.createElement("span");a.innerHTML=o,null===(l=n.parentElement)||void 0===l||l.replaceChild(a,n)}}return d.length+c},ue=(e,t)=>{const n=ie(e,t.regex_dynamic,t,!0);n>0&&(i.debug(`Replaced ${t.name} via dynamic method at least ${n} time(s)`),t.count_on_page+=n)},pe=(e,t)=>{const n=ce(e,t.regex_editable,t,!0);n>0&&(i.debug(`Replaced ${t.name} via editable method at least ${n} time(s)`),t.count_on_page+=n)},he=(e,t,n)=>{const o=fe(e,t,n);o>0&&(i.debug(`Replaced ${t.name} via normal (${n.settings.normal_is_alias_for}) method at least ${o} time(s)`),t.count_on_page+=o)},fe=(e,t,n)=>{switch(n.settings.normal_is_alias_for){case"dynamic":return ie(e,t.regex_normal,t,!1);case"editable":return ce(e,t.regex_normal,t,!1);case"html":return re(e,t.regex_html,t.expanded_value);case"static":return ae(e,t.regex_static,t.expanded_value);default:return console.warn(`Unknown replace type mapped in 'settings.normal_is_alias_for': ${n.settings.normal_is_alias_for}. Skipping replacing normal placeholders`),0}},_e=(e,t)=>{const n=ae(e,t.regex_static,t.expanded_value);n>0&&(i.debug(`Replaced ${t.name} via static method at least ${n} time(s)`),t.count_on_page+=n,t.reload_page_on_change=!0)},ge=(e,t)=>{const n=re(e,t.regex_html,t.expanded_value);n>0&&(i.debug(`Replaced ${t.name} via innerHTML method at least ${n} time(s)`),t.count_on_page+=n,t.reload_page_on_change=!0)},me=(e,t,n)=>e.replace(t.regex_dynamic,n).replace(t.regex_editable,n).replace(t.regex_html,n).replace(t.regex_normal,n).replace(t.regex_static,n),ve=e=>{for(const t of e)if(t.output_elements.length>0){for(const e of t.output_elements)be(e,t.expanded_value);if(t.type==Ne.Textbox){const e=g(t,t.expanded_value);for(const n of t.output_elements)n.classList.contains("placeholder-value-editable")&&x(n,e)}else if(t.type==Ne.Checkbox)for(const e of t.output_elements)e.classList.contains("placeholder-value-checkbox")&&ne(e,t)}},be=(e,t)=>{t?e.classList.remove("value-empty"):e.classList.add("value-empty");for(const n of e.childNodes)if(n.nodeType===Node.TEXT_NODE)return void(n.textContent=t);e.insertAdjacentText("afterbegin",t)};class we{constructor(e){this.placeholders=e,this.nodes=new Map,this.reset()}reset(){this.nodes.clear();for(const e of this.placeholders.values())this.nodes.set(e.name,new ye(e));for(const e of this.placeholders.values())try{this.on_placeholder_value_change(e)}catch(e){console.error("Error while building dependency graph",e),console.warn("Placeholder values may be inconsistent. Clearing your localStorage should fix this problem."),confirm("We detected a problem with your placeholder values. Resetting them to the defaults should fix this. Should we reset your placeholders?")&&D()}for(const e of this.nodes.values())0==e.downlinks.length&&e.recalculate_expanded_value(!0)}debug_print_representation(){let e="Dependency graph nodes (DEBUG view):";for(const t of this.nodes.values()){const n=t.downlinks.map((e=>e.placeholder.name)).join(", ");0==n.length?e+=`\n${t.placeholder.name} (${t.placeholder.expanded_value}) has no dependencies`:e+=`\n${t.placeholder.name} (${t.placeholder.expanded_value}) depends on ${n}`}i.debug(e)}unmark_everything(){for(const e of this.nodes.values())e.marked=!1}get_node(e){const t=this.nodes.get(e.name);if(null==t)throw new Error(`Placeholder ${e.name} is not part of the dependency graph`);return t}on_placeholder_value_change(e){const t=this.get_node(e);if(this.update_placeholder_downlinks(e),this.has_loop())throw e.expanded_value=e.current_value,t.downlinks=[],new Error(`Placeholder ${e.name} was part of a loop and has temporarily been made non-recursive`);t.recalculate_expanded_value(!0)}get_all_marked(){const e=[];for(const t of this.nodes.values())t.marked&&e.push(t.placeholder);return e}get_all_upstream(e){return this.unmark_everything(),this.get_node(e).recursive_mark_upstream(),this.get_all_marked()}update_placeholder_downlinks(e){if(!e.allow_nested)return void i.debug(`${e.name} can not contain nested placeholders`);const t=this.get_node(e);for(const e of t.downlinks)e.remove_uplink(t);t.downlinks=[];for(const n of this.nodes.values())n!=t&&xe(e.current_value,n.placeholder)&&(t.downlinks.push(n),n.uplinks.push(t))}get_all_used_placeholders(){this.unmark_everything();for(const e of this.nodes.values())e.placeholder.count_on_page>0&&e.recursive_mark_downstream();return this.get_all_marked()}has_loop(){this.unmark_everything();for(const e of this.nodes.values())if(!e.marked&&this._has_loop([],e))return!0;return!1}_has_loop(e,t){const n=[...e,t],o=e.indexOf(t);if(-1!=o){let e="Dependency cycle in placeholders detected:";for(let t=o;t<n.length;t++){const o=n[t].placeholder;e+=`\n$ -> ${o.name}: ${o.current_value}`}return console.warn(e),!0}if(t.marked)return!1;t.marked=!0;for(const e of t.downlinks)if(this._has_loop(n,e))return!0;return!1}}const xe=(e,t)=>t.regex_dynamic.test(e)||t.regex_editable.test(e)||t.regex_html.test(e)||t.regex_normal.test(e)||t.regex_static.test(e);class ye{constructor(e){this.uplinks=[],this.downlinks=[],this.marked=!1,this.placeholder=e}remove_uplink(e){this.uplinks=this.uplinks.filter((t=>t!=e))}recalculate_expanded_value(e){let t=this.placeholder.current_value;if(this.placeholder.allow_nested&&(t=((e,t)=>{if(0==t.length)return e;if(1==t.length){const n=t[0];return me(e,n,n.expanded_value)}{const n=`${Date.now()}_${Math.random()}`;for(const o of t)e=me(e,o,`x${o.name}#${n}x`);for(const o of t){const t=new RegExp(`x${o.name}#${n}x`,"g");e=e.replace(t,o.expanded_value)}return e}})(t,this.downlinks.map((e=>e.placeholder)))),this.placeholder.expanded_value=t,e)for(const t of this.uplinks)t.recalculate_expanded_value(e)}recursive_mark_upstream(){this.marked=!0;for(const e of this.uplinks)e.recursive_mark_upstream()}recursive_mark_downstream(){this.marked=!0;for(const e of this.downlinks)e.recursive_mark_downstream()}}const $e=(e,t,n)=>{const o=n[e],a=typeof o;if(a!=t)throw new Error(`Type mismatch: ${e} should be ${t}, but is ${a}.\nProblematic object: ${JSON.stringify(n)}`);return o},ke=(e,t)=>$e(e,"string",t),Ee=(e,t)=>$e(e,"boolean",t),Le=(e,t)=>$e(e,"number",t),Te=(e,t,n)=>{const o=n[e];if(Array.isArray(o)){for(const[a,l]of o.entries()){const o=typeof l;if(o!=t){const l=`Type mismatch: ${e}'s ${a+1}th element should be ${t}, but is ${o}.\nProblematic object: ${JSON.stringify(n)}`;throw new Error(l)}}return o}throw new Error(`Type mismatch: ${e} should be an array, but is not.\nProblematic object: ${JSON.stringify(n)}`)};var Ce,Ne;!function(e){e.Editable="editable"}(Ce||(Ce={})),function(e){e.Textbox="TEXTBOX",e.Checkbox="CHECKBOX",e.Dropdown="DROPDOWN"}(Ne||(Ne={}));const De=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Se=(e,t,n,o)=>{const a=ke("type",e),l=ke("name",e),r={name:l,order_index:o,regex_dynamic:RegExp(De(n.dynamic_prefix)+l+De(n.dynamic_suffix),"g"),regex_editable:RegExp(De(n.editable_prefix)+l+De(n.editable_suffix),"g"),regex_html:RegExp(De(n.html_prefix)+l+De(n.html_suffix),"g"),regex_normal:RegExp(De(n.normal_prefix)+l+De(n.normal_suffix),"g"),regex_static:RegExp(De(n.static_prefix)+l+De(n.static_suffix),"g"),default_tooltip:"",description:ke("description",e),read_only:Ee("read_only",e),allow_inner_html:Ee("allow_inner_html",e),allow_nested:Ee("allow_nested",e),current_value:"UNINITIALIZED",expanded_value:"UNINITIALIZED",count_on_page:0,reload_page_on_change:!1,output_elements:[]};if("textbox"===a){const n=Ae(r,e,t);return(e=>{const t=T(`${e.name}_TEXT`);if(null!=t){if(f(e,t))return void(e.current_value=t);console.warn(`Stored value for placeholder ${e.name} is invalid: '${t}'. Will revert to default.`)}if(null!=e.default_value)e.current_value=e.default_value,f(e,e.default_value)||console.warn(`Default value for placeholder '${e.name}' is invalid: '${e.default_value}'`);else{if(!e.default_function)throw new Error(`Either 'default_value' or 'default_function' needs to be set for placeholder ${e.name}`);try{const t=e.default_function();e.current_value=t;try{I(e,t)}catch(n){console.warn(`Default function for placeholder '${e.name}' returned invalid value: '${t}'`)}}catch(t){console.error(`Error while loading default textbox state for placeholder ${e.name}:`,t),e.current_value="DEFAULT_FUNCTION_ERROR"}}})(n),n}if("checkbox"==a){const t=Re(r,e);return(e=>{const t=T(`${e.name}_IS_CHECKED`);null==t?e.current_is_checked=e.checked_by_default:"0"==t||"1"==t?e.current_is_checked="1"==t:(console.warn(`Unexpected state for checkbox. Should be '0' or '1', but was '${t}'`),e.current_is_checked=e.checked_by_default),e.current_value=e.current_is_checked?e.value_checked:e.value_unchecked})(t),t}if("dropdown"==a){const t=Pe(r,e);return(e=>{const t=T(`${e.name}_INDEX`);if(null==t)e.current_index=e.default_index;else{const n=Number(t);R(e,n)?e.current_index=n:(console.warn(`Unexpected state for dropdown. Should be a whole number N, where 0 <= N < ${e.options.length}. But it is ${t}`),e.current_index=e.default_index)}e.current_value=e.options[e.current_index].value})(t),t}throw new Error(`Unsupported placeholder type '${a}'`)},Ae=(e,t,n)=>{let o,a;if(null!=t.default_value)a=ke("default_value",t);else{const n=ke("default_function",t);o=()=>{try{const e=new Function(n)();if("string"!=typeof e)throw new Error(`Custom function '${n}' should return a string, but it returned a ${typeof e}: ${e}`);return e}catch(t){throw new Error(`Failed to evaluate default_function '${n}' of placeholder ${e.name}: ${t}`)}}}const l=Te("validators","string",t),r=[];for(const e of l){const t=n.get(e);if(!t){const t=Array.from(n.keys()).join(", ");throw new Error(`No validator with id '${e}' was found. Known validators are ${t}`)}r.push(t)}const s=e.description?`\nDescription: ${e.description}`:"",i=a?`\nDefault value: ${a}`:"\nDefault value generated by function",c=`Placeholder name: ${e.name}${s}${i}\nUsage: Click to edit the value. Leaving the text field or pressing enter will store the new value, pressing Escape will revert current changes. While editing the field, the tooltip will show warnings/errors if your value is not what is expected`;return Object.assign(Object.assign({},e),{default_tooltip:c,default_function:o,default_value:a,input_elements:[],type:Ne.Textbox,validators:r})},Re=(e,t)=>Object.assign(Object.assign({},e),{checked_by_default:Ee("checked_by_default",t),current_is_checked:!1,input_elements:[],value_checked:ke("value_checked",t),value_unchecked:ke("value_unchecked",t),type:Ne.Checkbox}),Pe=(e,t)=>{const n=Te("options","object",t),o=[];for(const e of n)o.push({display_name:ke("display_name",e),value:ke("value",e)});const a=Le("default_index",t);if(a<0)throw new Error(`Invalid value: "default_index" should not be negative, but is ${a}.\nProblematic object: ${JSON.stringify(t)}`);if(a>=o.length)throw new Error(`Invalid value: "default_index" should be smaller than the number of options (${o.length}), but is ${a}.\nProblematic object: ${JSON.stringify(t)}`);const l=e.description?`\nDescription: ${e.description}`:"";let r=`Placeholder name: ${e.name}${l}\nDefault option: ${o[a].value}\nUsage: (left-)click to cycle forward through the values, right-click to cycle through backwards. You can also use the Enter, Up, and Down keys if the placeholder is selected.\nPossible values:`;for(const e of o)r+=`\n- ${e.value}`;return Object.assign(Object.assign({},e),{default_tooltip:r,current_index:0,default_index:a,input_elements:[],options:o,type:Ne.Dropdown})},Ie=()=>{const e=(e=>{const t=new Map,n=new Map,o=new Map,a=new Map,l=new Map,r=Te("validators","object",e);for(const e of r){const t=p(e);if(l.has(t.id))throw new Error(`Multiple validators with id '${t.id}'`);l.set(t.id,t)}const s=(e=>{const t=Ee("apply_change_on_focus_change",e),n=Ee("debug",e),o=Ee("expand_auto_tables",e),a=Ee("inline_editors",e),l=Ee("inline_editor_icons",e);return{apply_change_on_focus_change:C("apply_change_on_focus_change",t),debug:C("debug",n),delay_millis:Le("delay_millis",e),expand_auto_tables:C("expand_auto_tables",o),highlight_placeholders:C("highlight_placeholders",!1),inline_editors:C("inline_editors",a),inline_editor_icons:C("inline_editor_icons",l),normal_is_alias_for:ke("normal_is_alias_for",e),normal_prefix:ke("normal_prefix",e),normal_suffix:ke("normal_suffix",e),editable_prefix:ke("editable_prefix",e),editable_suffix:ke("editable_suffix",e),html_prefix:ke("html_prefix",e),html_suffix:ke("html_suffix",e),static_prefix:ke("static_prefix",e),static_suffix:ke("static_suffix",e),dynamic_prefix:ke("dynamic_prefix",e),dynamic_suffix:ke("dynamic_suffix",e)}})($e("settings","object",e)),i=Te("placeholder_list","object",e);for(let e=0;e<i.length;e++){const r=Se(i[e],l,s,e);t.set(r.name,r),r.type==Ne.Textbox?n.set(r.name,r):r.type==Ne.Checkbox?o.set(r.name,r):r.type==Ne.Dropdown?a.set(r.name,r):console.warn("Unknown placeholder type:",r.type)}return{placeholders:t,textboxes:n,checkboxes:o,dropdowns:a,settings:s,dependency_graph:new we(t),input_tables:[],event_listener_abort_controller:new AbortController}})(window.PlaceholderPluginConfigJson);var t;t=e.settings.debug,i=t?{log:n,info:o,debug:a}:s,i.info("PluginConfig",e),(e=>{window.PlaceholderPlugin={settings:e.settings,placeholders:e.placeholders,debug_disable_reload:c,debug_print_dependency_graph:()=>e.dependency_graph.debug_print_representation()}})(e);const l=e.settings.delay_millis,r=window.document$;r?r.subscribe((()=>{l>0?setTimeout((()=>He(e)),l):He(e)})):l<0?He(e):0==l?window.addEventListener("load",(()=>He(e))):window.addEventListener("load",(()=>{setTimeout((()=>He(e)),l)}))},He=e=>{i.info("Called do_plugin_stuff (function for parsing and modifying the page)"),e.placeholders.forEach(((e,t,n)=>{e.count_on_page=0,e.input_elements=[]})),((e,t)=>{for(const n of t.placeholders.values())ue(e,n),pe(e,n),he(e,n,t),_e(e,n),n.allow_inner_html&&ge(e,n);(e=>{const t=document.querySelectorAll(".placeholder-value[data-placeholder]");for(const n of t){const t=n.getAttribute("data-placeholder");if(t){const o=e.placeholders.get(t);o?o.output_elements.push(n):console.warn(`No placeholder named '${t}', that is referenced by element:`,n)}else console.warn("Element has empty/no attribute 'data-placeholder':",n)}})(t),ve([...t.placeholders.values()])})(document.body,e),e.dependency_graph.debug_print_representation(),(e=>{const t=document.querySelectorAll("input[data-input-for], select[data-input-for]");for(const n of t){const t=n.getAttribute("data-input-for");if(null==t)throw new Error("How can this be, the selector forces the 'data-input-for' attribute to exist");const o=e.placeholders.get(t);o?Z(e,o,n):(console.warn(`Unknown placeholder referenced in input element: '${t}'`),n.classList.add("input-for-variable"),n.value=`ERROR_UNDEFINED_PLACEHOLDER: ${t}`)}})(e),(e=>{const t=document.querySelectorAll("div.auto-input-table");if(t.length>0){const n=e.dependency_graph.get_all_used_placeholders().filter((e=>!e.read_only));for(const o of t)if(o instanceof HTMLElement){const t=o.getAttribute("data-columns")||"name,input",a=t.includes(",")?t.split(","):[t],l=null===o.getAttribute("data-hide-empty");J(o,a,e,n,l)}else console.warn("Element",o,"is expected to be an HTMLElement, but is not")}})(e),(e=>{const t=document.querySelectorAll("div.placeholder-settings-panel");for(const n of t)B(e,n,!1)})(e),e.settings.inline_editors&&U(e),document.body.classList.add("placeholder-plugin-init-done")};window.PlaceholderPluginConfigJson?Ie():document.addEventListener("PlaceholderPluginConfigJson",Ie)})();
//# sourceMappingURL=placeholder.min.js.map