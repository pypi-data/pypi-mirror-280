var k="0.0.3",p=1;function v(c){c=c.toLowerCase();var e=null,n=Array.prototype.find;return n.call(document.styleSheets,o=>(e=n.call(o.cssRules,a=>a instanceof CSSStyleRule&&a.selectorText.toLowerCase()==c),e!=null)),e}var m={};async function w(c,e="get",n={},o=!0,a={},t=!1){let s={method:e,...a};if(e==="get"){let u=new URLSearchParams(n).toString();if(u.length>0&&(c+="?"+u),t&&(delete s.trycache,m.hasOwnProperty(c)))return m[c]}else s.headers=s.headers?s.headers:{},s.headers={"Content-Type":"application/json",...s.headers},s.body=JSON.stringify(n);o&&(s.headers={Authorization:"Bearer "+sessionStorage.elifeToken,...s.headers});const i=await fetch(c,s);if(i.status!==200)throw alert("HTTP error : "+i.status),"HTTP error : "+i.status;let l=await i.json();if(l.ret!=0&&l.ret>0)throw alert(l.msg),l.msg;return a.trycache&&(m[c]=l),l}class T{constructor(){this.subscribers=[],this.mustMsgList=[],this.ws=null,this.wsconnect(),this.ws_port=null}async wsconnect(){if(!this.ws_port){let o=await w("/api/get_ws_port","post",{cmd:"get_ws_port"});this.ws_port=o.ws_port}let e=`ws://${window.location.hostname}:${this.ws_port}/client`;var n=new WebSocket(e);n.onopen=o=>{console.log("ws connected ok."),document.getElementById("ws_connectiong_state").innerHTML="🛜";for(let a of this.mustMsgList)n.send(JSON.stringify(a,void 0,2));this.mustMsgList=[]},n.onmessage=o=>{try{let a=JSON.parse(o.data);for(let t of this.subscribers)t.handleWSMsg(a)}catch(a){console.log(a)}},n.onclose=o=>{setTimeout(a=>{this.wsconnect()},10),document.getElementById("ws_connectiong_state").innerHTML="⚠️"},n.onerror=o=>{console.log("Socket encountered error, closing socket"),n.close()},this.ws=n}sendMsg(e,n=!1){return!this.ws||this.ws.readyState!==1?n?(this.mustMsgList.push(e),2):1:(this.ws.send(JSON.stringify(e,void 0,2)),0)}register(e){this.subscribers.indexOf(e)<0&&this.subscribers.push(e)}unregister(e){const n=this.subscribers.indexOf(e);n>=0&&this.subscribers.splice(n,1)}}const d=new T;class C{constructor(){this.subscribers=[],this.needCallPrism=!1,this.show_result_details=!0,this.curTest={showAddTest:!1,addTest_keys:[],addTest_tags:[],addTest_nodeIds:[],name:"--",results:[],start_time:"--",end_time:"--",duration:0,stats:{total:0,deselected:0,rtotal:0,executed:0,passed:0,failed:0,skipped:0,xfailed:0,xpassed:0,st_error:0,st_ok:0},collect_errors:[],server_working_dir:"--",haveRun:!1,testAborted:!1,pytest_cases_tree:{},pytest_cases_tree_curFile:null}}register(e){this.subscribers.indexOf(e)<0&&this.subscribers.push(e)}unregister(e){const n=this.subscribers.indexOf(e);n>=0&&this.subscribers.splice(n,1)}broadcast(e,n){for(let o of this.subscribers)o.handleDCMsg(e,n)}}const r=new C;function h(c="#cddee6"){return React.createElement("div",{style:{borderRight:`1px solid ${c}`}})}function y(c="#cddee6"){return React.createElement("div",{style:{borderBottom:`1px solid ${c}`}})}export default class N extends React.Component{constructor(e){super(e),this.state={showWhat:"runningSession",curHistoryReport:null,report:null},this.intervalId=setInterval(()=>{r.needCallPrism&&(Prism.highlightAll(),r.needCallPrism=!1)},2e3)}handleWSMsg(e){switch(e.event){case"term":console.log(e.data);break;case"result.get_server_version":if(e.version!==k){async function o(a){await fetch(a,{headers:{Pragma:"no-cache",Expires:"-1","Cache-Control":"no-cache"}}),window.location.href=a,window.location.reload()}alert(["The Browser cached page is old, click OK for auto refreshing.","浏览器缓存网页过时，点击确定后自动化刷新到新版本"][p]),o(window.location.href)}break;case"result.get_history_report":let n=JSON.parse(e.content);this.setState({report:n}),setTimeout(()=>{Prism.highlightAll()},1e3);break}}componentDidMount(){d.register(this);let e=d.sendMsg({event:"get_server_version"},!0)}componentWillUnmount(){d.unregister(this)}showWhatChanged(e,n){this.setState({showWhat:e,curHistoryReport:n})}render(){return React.createElement(React.Fragment,null,React.createElement(S,{showWhatChanged:(e,n)=>{this.showWhatChanged(e,n)},showWhat:this.state.showWhat,curHistoryReport:this.state.curHistoryReport}),this.state.showWhat==="runningSession"?React.createElement(x,null):React.createElement(M,{report:this.state.report}))}}class S extends React.Component{constructor(e){super(e),this.state={history_reports:[],select_rules:[]}}handleWSMsg(e){let n;switch(e.event){case"result.list_history_reports":this.setState({history_reports:e.items});break;case"result.deleteall_history_reports":e.ret===0&&this.setState({history_reports:[]});break;case"result.delete_this_history_report":e.ret===0&&d.sendMsg({event:"list_history_reports"});break;case"result.list_select_rules":this.setState({select_rules:e.items});break;case"result.deleteall_select_rules":e.ret===0&&this.setState({select_rules:[]});break;case"result.delete_this_select_rule":e.ret===0&&d.sendMsg({event:"list_select_rules"});break;case"result.save_select_rule":e.ret===0?this.setState({select_rules:e.items}):alert(e.info);break}}componentDidMount(){d.register(this),d.sendMsg({event:"list_history_reports"},!0),d.sendMsg({event:"list_select_rules"},!0)}componentWillUnmount(){d.unregister(this)}render(){return React.createElement("div",{className:"menu"},React.createElement("div",null,React.createElement("span",{className:"ongoing-test btn-no-border",style:{fontSize:".9rem"},onClick:e=>{this.props.showWhatChanged("runningSession")}},"当前测试"),this.props.showWhat==="runningSession"?React.createElement("span",null,"💎"):null),y(),React.createElement("div",null,React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},React.createElement("span",{style:{padding:".2rem .5rem",fontSize:".9rem"},title:"按shift双击下方记录，可以删除",className:"btn-no-border"},"结果记录"),React.createElement("span",{className:"btn-no-border",title:"刷新",onClick:e=>{this.setState({history_reports:[]}),d.sendMsg({event:"list_history_reports"})}},"🔄️"),this.state.history_reports.length>0?React.createElement("span",{className:"btn-no-border",onClick:e=>{confirm("确定要删除所有测试结果吗？")&&d.sendMsg({event:"deleteall_history_reports"})}},"全部删除"):null),React.createElement("div",{className:"history-report"},this.state.history_reports.map(e=>React.createElement("div",{className:"hlayout btn-no-border color2",key:e,onDoubleClick:n=>{if(n.shiftKey)d.sendMsg({event:"delete_this_history_report",name:e}),this.props.curHistoryReport===e&&this.props.showWhatChanged("runningSession");else{if(this.props.curHistoryReport===e)return;d.sendMsg({event:"get_history_report",name:e}),this.props.showWhatChanged("historySession",e)}}},React.createElement("span",{style:{margin:".2rem 1rem"}},e),this.props.curHistoryReport===e?React.createElement("span",null,"💎"):null)))),y(),this.genGroup("参数记录","select_rule","select_rules",this.state.select_rules,e=>{this.props.showWhatChanged("runningSession"),r.curTest.showAddTest=!0,d.sendMsg({event:"get_select_rule",name:e})},"color3"))}genGroup(e,n,o,a,t,s="color2"){return React.createElement("div",null,React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},React.createElement("span",{style:{padding:".2rem .5rem",fontSize:".9rem"},title:"按shift双击下方记录，可以删除",className:`btn-no-border ${s}`},e),React.createElement("span",{className:"btn-no-border",title:"刷新",onClick:i=>{this.setState({[o]:[]}),d.sendMsg({event:`list_${o}`})}},"🔄️"),a.length>0?React.createElement("span",{className:`btn-no-border ${s}`,onClick:i=>{confirm(`确定要删除所有${e}吗？`)&&d.sendMsg({event:`deleteall_${o}`})}},"全部删除"):null),React.createElement("div",{className:o},a.map(i=>React.createElement("div",{className:"hlayout btn-no-border color2",key:i,onDoubleClick:l=>{l.shiftKey?d.sendMsg({event:`delete_this_${n}`,name:i}):t(i)}},React.createElement("span",{style:{margin:".2rem 1rem"}},i)))))}}class x extends React.Component{resetRunningSession(){let e=r.curTest;e.name="--",e.results.length=0,e.start_time="--",e.end_time="--",e.duration=0,e.stats={deselected:0,rtotal:0,executed:0,passed:0,failed:0,skipped:0,xfailed:0,xpassed:0,st_error:0},e.collect_errors=[],e.server_working_dir="--",e.testAborted=!1}handleWSMsg(e){let n=r.curTest.results;switch(e.event){case"result.get_select_rule":let o=JSON.parse(e.content);r.curTest.showAddTest=!0,r.curTest.addTest_keys=o.keys,r.curTest.addTest_tags=o.tags,r.curTest.addTest_nodeIds=o.nodeIds,document.getElementById("addTest_name").value=o.name,document.getElementById("addTest_keys").value="",document.getElementById("addTest_tags").value="";break;case"result.collect_cases":r.curTest.pytest_cases_tree=e.caseTree;break;case"result.open_new_test":e.ret!==0&&alert(e.info);break;case"result.abort_testing":e.ret===0?r.curTest.testAborted=!0:alert(e.info);break;case"run-test-loop":this.resetRunningSession(),r.curTest.haveRun=!0,r.curTest.name=e.name,r.curTest.start_time=e.start_time,r.curTest.server_working_dir=e.working_dir,r.curTest.stats=e.stats,document.getElementById("test-progress").max=e.stats.rtotal,document.getElementById("test-progress").value=0;break;case"pytest_terminal_summary":r.curTest.stats=e.stats,r.curTest.collect_errors=e.collect_errors;break;case"test-session-end":r.curTest.end_time=e.end_time,r.curTest.duration=e.duration,d.sendMsg({event:"list_history_reports"});break;case"one-case-begin":break;case"one-case-end":n.push(e.result),r.curTest.haveRun=!0,r.curTest.stats=e.stats,r.needCallPrism=!0,document.getElementById("test-progress").max=e.stats.rtotal,document.getElementById("test-progress").value=e.stats.executed,r.curTest.results[0].idx!=0&&(console.log("send query_current_testing_state"),d.sendMsg({event:"query_current_testing_state",toIdx:r.curTest.results[0].idx}));break;case"result.current-testing-state":e.results&&(r.curTest.name=e.name,r.curTest.working_dir=e.working_dir,r.curTest.start_time=e.start_time,n.unshift(...e.results));break}this.forceUpdate()}async componentDidMount(){d.register(this)}componentWillUnmount(){d.unregister(this)}render(){return React.createElement("div",{className:"test-session"},this.sectionAddTest(r.curTest),this.sectionSummary(r.curTest),r.curTest.haveRun?React.createElement(g,{rData:r.curTest}):null)}sectionAddTest(e){const n=(t,s)=>{if(t.key==="Enter"){if(s.indexOf(t.target.value)>=0)return;s.push(t.target.value),t.target.value="",this.forceUpdate()}},o=t=>{r.curTest.addTest_nodeIds.indexOf(t)>=0||(r.curTest.addTest_nodeIds.push(t),this.forceUpdate())},a=t=>{let s=JSON.parse(JSON.stringify(r.curTest.addTest_keys)),i=JSON.parse(JSON.stringify(r.curTest.addTest_tags)),l=document.getElementById("addTest_keys").value.trim();return l&&s.push(l),l=document.getElementById("addTest_tags").value.trim(),l&&i.push(l),{name:document.getElementById("addTest_name").value.trim(),keys:s,tags:i,nodeIds:r.curTest.addTest_nodeIds}};return React.createElement(React.Fragment,null,React.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-evenly",backgroundColor:"#fff8f0"}},React.createElement("span",{className:"btn-no-border color2",style:{fontSize:".92rem"},onClick:t=>{r.curTest.showAddTest||(r.curTest.showAddTest=!0,this.forceUpdate(),d.sendMsg({event:"collect_cases"}))}},"测试参数设置"),React.createElement("div",{className:"hlayout",style:{gap:"2rem"}},React.createElement("span",{className:"btn-no-border color2",onClick:t=>{confirm("确定要 中止测试 吗？")&&d.sendMsg({event:"abort_testing"})}},"中止测试"),React.createElement("span",{className:"btn-no-border color2",onClick:t=>{confirm("确定要 强制停止测试 吗？")&&d.sendMsg({event:"force_abort_testing"})}},"强制停止测试"),React.createElement("span",{className:"btn-no-border color2",onClick:t=>{confirm("确定要 关闭后台 吗？")&&d.sendMsg({event:"kill_pytest_assist"})}},"关闭后台"))),r.curTest.showAddTest?React.createElement("div",{className:"add-test-zone"},React.createElement("div",{style:{display:"flex",justifyContent:"space-around",alignItems:"center",background:"aliceblue"}},React.createElement("span",{className:"btn-no-border",style:{marginRight:"5rem"},onClick:t=>{let s=a();d.sendMsg({event:"open_new_test",...s,saveRecord:document.getElementById("saveRecord").checked}),this.resetRunningSession(),this.forceUpdate()}},"执行测试"),React.createElement("span",{className:"btn-no-border color2",onClick:t=>{let s=a();d.sendMsg({event:"save_select_rule",...s})}},"保存参数"),React.createElement("span",{className:"btn-no-border color2",onClick:t=>{r.curTest.showAddTest=!1,this.forceUpdate()}},"收起界面")),React.createElement("div",{className:"entry"},React.createElement("span",null,"测试名称"),React.createElement("input",{id:"addTest_name",onChange:t=>{t.target.value=t.target.value.replace(/[^\w\-\_]/gi,"")}}),React.createElement("div",{style:{display:"flex",alignItems:"center",marginLeft:"2rem"}},React.createElement("span",null,"保存测试记录"),React.createElement("input",{type:"checkbox",id:"saveRecord",defaultChecked:!0}))),React.createElement("div",{className:"entry"},React.createElement("span",null,"关键字过滤"),React.createElement("input",{id:"addTest_keys",onKeyDown:t=>n(t,r.curTest.addTest_keys)}),React.createElement("div",{className:"items"},r.curTest.addTest_keys.map((t,s)=>React.createElement("span",{className:"btn-border",key:t,onClick:i=>{r.curTest.addTest_keys.splice(s,1),this.forceUpdate()}},t)))),React.createElement("div",{className:"entry"},React.createElement("span",null,"标签过滤"),React.createElement("input",{id:"addTest_tags",onKeyDown:t=>n(t,r.curTest.addTest_tags)}),React.createElement("div",{className:"items"},r.curTest.addTest_tags.map((t,s)=>React.createElement("span",{className:"btn-border",key:t,onClick:i=>{r.curTest.addTest_tags.splice(s,1),this.forceUpdate()}},t)))),React.createElement("div",{className:"entry",style:{alignItems:"baseline"}},React.createElement("div",{className:"hlayout"},React.createElement("span",null,"目标目录/文件/用例"),React.createElement("span",{className:"btn-no-border",title:"刷新",onClick:t=>{e.pytest_cases_tree={},this.forceUpdate(),d.sendMsg({event:"collect_cases"})}},"🔄️")),React.createElement("div",{className:"tree"},React.createElement("div",{className:"files"},(()=>{let t=[];for(let[s,i]of Object.entries(e.pytest_cases_tree)){let l=React.createElement("span",{className:"tree-node-file",key:s,onClick:u=>{e.pytest_cases_tree_curFile=s,this.forceUpdate()},onDoubleClick:u=>{o(s)}},s);t.push(l)}return t})()),e.pytest_cases_tree_curFile&&e.pytest_cases_tree.hasOwnProperty(e.pytest_cases_tree_curFile)?React.createElement("div",{className:"funcs"},(()=>{let t=[],s=e.pytest_cases_tree_curFile,i=e.pytest_cases_tree[e.pytest_cases_tree_curFile];for(let[l,u]of Object.entries(i.sub)){let f=`${s}::${l}`;if(u.type==="func")t.push(React.createElement("span",{className:"tree-node-func1",key:l,onDoubleClick:_=>{o(f)}},l));else{t.push(React.createElement("span",{className:"tree-node-class",key:l,onDoubleClick:_=>{o(f)}},l));for(let[_,R]of Object.entries(u.sub))t.push(React.createElement("span",{className:"tree-node-func2",key:_,onDoubleClick:I=>{let b=`${f}::${_}`;o(b)}},_))}}return t})()):null),React.createElement("div",{className:"items"},r.curTest.addTest_nodeIds.map((t,s)=>React.createElement("span",{className:"btn-border",key:t,onClick:i=>{r.curTest.addTest_nodeIds.splice(s,1),this.forceUpdate()}},t))))):null)}sectionSummary(e){return React.createElement("div",{className:"test-summary-zone",style:{visibility:e.haveRun?"visible":"hidden"}},React.createElement("div",{className:"left"},React.createElement("div",null," 测试名称：",e.name,"  "),React.createElement("div",null," 开始时间：",e.start_time,"  "),React.createElement("div",null," 结束时间：",e.end_time," ",e.duration?` ⏱️= ${e.duration.toFixed(0)} 秒`:null)),React.createElement("div",{className:"mid"},React.createElement("div",null," 工作目录： ",e.server_working_dir),React.createElement("div",{style:{display:"flex",gap:".8rem"}},React.createElement("span",null,"总计 : ",e.stats.rtotal),h(),React.createElement("span",null,"已执行 : ",e.stats.executed),h(),React.createElement("span",null,"剩余 : ",e.stats.rtotal-e.stats.executed)),React.createElement("div",{style:{display:"flex",gap:"1rem",alignItems:"center"}},React.createElement("label",{for:"test-progress"},"测试进度"),React.createElement("progress",{id:"test-progress",value:"0",max:"0"}),e.testAborted?React.createElement("span",{style:{color:"red"}},"已中止"):null,!e.testAborted&&e.duration?React.createElement("span",{style:{color:"#2196f3"}},"已完毕"):null)))}}class M extends React.Component{async componentDidMount(){d.register(this)}componentWillUnmount(){d.unregister(this)}handleWSMsg(e){switch(e.event){case"result.export_this_history_report":if(e.ret!==0){alert(e.msg);return}window.open(e.link,"_self");break}}render(){let e=this.props.report;return React.createElement("div",{className:"test-session",style:{backgroundColor:"#f1f8fa"}},this.sectionSummary(e),React.createElement(g,{rData:e}))}sectionSummary(e){return e?React.createElement("div",{className:"test-summary-zone"},React.createElement("div",{className:"left"},React.createElement("div",null," 测试名称：",e.name,"  "),React.createElement("div",null," 开始时间：",e.start_time,"  "),React.createElement("div",null," 结束时间：",e.end_time," ",` ⏱️= ${e.duration.toFixed(0)} 秒`," ")),React.createElement("div",{className:"mid"}),React.createElement("div",{className:"right"},React.createElement("span",{className:"btn-no-border",onClick:n=>{confirm("确定要导出报告吗？")&&d.sendMsg({event:"export_this_history_report",name:e.name})}},"导出报告"))):null}}class g extends React.Component{constructor(e){super(e),this.state={showPassed:!0,showFailed:!0,showStErr:!0}}filterRuleOK(e){return!(!this.state.showPassed&&e.ret_c==="passed"||!this.state.showFailed&&e.ret_c==="failed"||!this.state.showStErr&&(e.ret_s==="error"||e.ret_t==="error"))}render(){let e=this.props.rData;function n(t){let s="";return t.ret_s==="ok"?t.ret_c==="passed"?t.ret_t==="ok"?s="passed":s="t_error":t.ret_c==="failed"&&(s="failed"):s="s_error",s}function o(t){return t.map(s=>s.reprtext||s.output||s.logs?React.createElement("div",{className:"report "+s.when,key:s.when},React.createElement("div",{className:"report-title"},React.createElement("div",null,s.when),React.createElement("div",null,s.duration)),s.logs&&s.logs.length>0?React.createElement("div",{className:"logs"},s.logs.map(i=>{const l=i.t;return l==="img"?React.createElement("img",{src:`/.pytest_assist/records/${e.name}/imgs/${i.src}`}):l==="txt"?React.createElement("span",{style:{color:i.c?i.c:"",fontWeight:i.w?i.w:""}},i.s):null})):null,s.reprtext?React.createElement("div",{className:"reprtext"},React.createElement("pre",null,React.createElement("code",{className:"language-py"},s.reprtext))):null,s.output?React.createElement("div",{className:"output"},s.output):null):null)}if(!e)return null;let a=e.stats;return React.createElement("div",{className:"test-result-zone"},React.createElement("div",{style:{display:"flex",gap:"3rem",justifyContent:"center",backgroundColor:"#ecf5fc"}},React.createElement("div",{style:{display:"flex",marginLeft:"2rem",gap:"1rem"}},React.createElement("span",null,["Total","总计"][p]," : ",a.rtotal," "),h("#6c7076"),a.deselected?React.createElement(React.Fragment,null,React.createElement("span",null,["Deselected","过滤掉"][p]," : ",a.deselected),h("#6c7076")):null,a.passed?React.createElement(React.Fragment,null,React.createElement("span",null,["Passed","通过"][p]," : ",a.passed),React.createElement("input",{type:"checkbox",defaultChecked:!0,onChange:t=>{this.setState({showPassed:t.target.checked}),t.target.checked&&(r.needCallPrism=!0)}}),h("#6c7076")):null,a.failed?React.createElement(React.Fragment,null,React.createElement("span",{style:{color:a.failed===0?"":"red"}},["Failed","不通过"][p]," : ",a.failed),React.createElement("input",{type:"checkbox",defaultChecked:!0,onChange:t=>{this.setState({showFailed:t.target.checked}),t.target.checked&&(r.needCallPrism=!0)}}),h("#6c7076")):null,a.st_error?React.createElement(React.Fragment,null,React.createElement("span",{style:{color:a.st_error===0?"":"#9e438b"}},["Errors","st错误"][p]," : ",a.st_error),React.createElement("input",{type:"checkbox",defaultChecked:!0,onChange:t=>{this.setState({showStErr:t.target.checked}),t.target.checked&&(r.needCallPrism=!0)}}),h("#6c7076")):null,a.skipped?React.createElement(React.Fragment,null,React.createElement("span",null,["Skipped","忽略"][p]," : ",a.skipped),h("#6c7076")):null,a.xfailed?React.createElement(React.Fragment,null,React.createElement("span",null,["Expected failures","预期不通过"][p]," : ",a.xfailed)):null),React.createElement("div",{style:{display:"flex",marginLeft:"2rem"}},React.createElement("span",null,"显示详情"),React.createElement("input",{type:"checkbox",id:"show_details",defaultChecked:r.show_result_details,onClick:t=>{let s=document.getElementById("show_details").checked;r.show_result_details=s;let i=s?"flex":"none",l=v(".test-result .details");l.style.display=i;for(let u of document.querySelectorAll(".test-result .details"))u.style.display=i}}))),e.collect_errors&&e.collect_errors.length?React.createElement("div",null,React.createElement("div",{style:{color:"#be2d2d",marginBottom:"1rem",fontWeight:"bold"}},["Collection Errors:","搜集用例出错："][p]),e.collect_errors.map((t,s)=>React.createElement("div",{key:s,style:{color:"#be2d2d",whiteSpace:"pre-wrap"}},t))):null,e.results?e.results.map(t=>this.filterRuleOK(t)&&React.createElement("div",{className:"test-result",key:t.idx},React.createElement("div",{className:"test-nodeid "+n(t),onClick:s=>{let i=v(".test-result .details").style.display,l=s.target.nextElementSibling.style,u=l.display;u==="none"?l.display="flex":u==="flex"?l.display="none":u===""&&(l.display=i==="flex"?"none":"flex")}},"  ",t.nodeid),React.createElement("div",{className:"details"},o(t.sct)))):null)}}
