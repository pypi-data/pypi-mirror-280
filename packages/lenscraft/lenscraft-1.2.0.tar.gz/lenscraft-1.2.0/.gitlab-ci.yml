stages:
  - build
  - test
  - deploy

build:
  image: python:3.10
  tags:
    - dind
  stage: build
  script:
    - git fetch --tags
    - pip install --upgrade build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

test:
  image: python:3.10
  tags:
    - dind
  stage: test
  dependencies:
    - build
  before_script:
    - apt-get update
    - apt-get install -y libgl1-mesa-glx
  script:
    - pip install pytest
    - pip install -e .
    - pytest tests/

deploy:
  image: python:3.10
  tags:
    - dind
  stage: deploy
  dependencies:
    - build
  script:
    - git fetch --tags
    - pip install twine
    - python -m twine upload --repository pypi dist/*
  rules:
    - if: $CI_COMMIT_TAG =~ /^(?:\d+.){2}(?:\d+)$/