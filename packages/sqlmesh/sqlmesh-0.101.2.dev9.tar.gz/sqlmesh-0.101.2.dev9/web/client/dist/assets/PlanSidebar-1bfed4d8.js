import{r as j,D as ze,ab as $e,I as Ve,y as Ge,x as ae,F as Le,R as H,ac as Ue,ad as He,ae as qe,X as Re,af as Ke,Q as Ze,M as we,j as e,a6 as pe,ag as Fe,a as W,a3 as g,o as E,a9 as ne,a7 as L,a2 as Q,a0 as A,a1 as P,ah as Qe,d as v,c as k,ai as Ne,aj as w,ak as q,k as M,e as U,al as K,t as X,b as Ie,$ as I,n as G,am as ke,an as Pe,L as ge,S as Ae,u as Me,a4 as We,ao as Xe,ap as Ye,E as Te}from"./index-45e2979d.js";import{B as z}from"./Banner-b525cead.js";import{R as Je,p as es}from"./ReportErrors-337f20c5.js";import{v as R,M as de,P as ue}from"./disclosure-4af2941a.js";import{M as ss,H as as,u as $,a as ve,b as D,E as N,P as _,C as me,c as ts}from"./PlanChangePreview-53bcd1d9.js";import{I as O}from"./SearchList-14ae8126.js";import{s as ns}from"./popover-fc660b3f.js";import{T as ls,p as is}from"./context-7d3868a2.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-f83a4b5f.js";import"./PlusIcon-257d00e1.js";function rs({title:s,titleId:a,...t},n){return j.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:n,"aria-labelledby":a},t),s?j.createElement("title",{id:a},s):null,j.createElement("path",{fillRule:"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"}))}const os=j.forwardRef(rs),cs=os;let be=j.createContext(null);be.displayName="GroupContext";let ds=j.Fragment;function us(s){var a;let[t,n]=j.useState(null),[l,i]=as(),[u,r]=Ke(),c=j.useMemo(()=>({switch:t,setSwitch:n,labelledby:l,describedby:u}),[t,n,l,u]),x={},h=s;return H.createElement(r,{name:"Switch.Description"},H.createElement(i,{name:"Switch.Label",props:{htmlFor:(a=c.switch)==null?void 0:a.id,onClick(d){t&&(d.currentTarget.tagName==="LABEL"&&d.preventDefault(),t.click(),t.focus({preventScroll:!0}))}}},H.createElement(be.Provider,{value:c},Re({ourProps:x,theirProps:h,defaultTag:ds,name:"Switch.Group"}))))}let ms="button";function xs(s,a){let t=Ve(),{id:n=`headlessui-switch-${t}`,checked:l,defaultChecked:i=!1,onChange:u,name:r,value:c,form:x,...h}=s,d=j.useContext(be),o=j.useRef(null),m=Ge(o,a,d===null?null:d.setSwitch),[b,p]=ls(l,u,i),T=ae(()=>p==null?void 0:p(!b)),F=ae(C=>{if(Ze(C.currentTarget))return C.preventDefault();C.preventDefault(),T()}),S=ae(C=>{C.key===we.Space?(C.preventDefault(),T()):C.key===we.Enter&&is(C.currentTarget)}),Z=ae(C=>C.preventDefault()),xe=j.useMemo(()=>({checked:b}),[b]),he={id:n,ref:m,role:"switch",type:ns(s,o),tabIndex:0,"aria-checked":b,"aria-labelledby":d==null?void 0:d.labelledby,"aria-describedby":d==null?void 0:d.describedby,onClick:F,onKeyUp:S,onKeyPress:Z},se=Le();return j.useEffect(()=>{var C;let y=(C=o.current)==null?void 0:C.closest("form");y&&i!==void 0&&se.addEventListener(y,"reset",()=>{p(i)})},[o,p]),H.createElement(H.Fragment,null,r!=null&&b&&H.createElement(Ue,{features:He.Hidden,...qe({as:"input",type:"checkbox",hidden:!0,readOnly:!0,form:x,checked:b,name:r,value:c})}),Re({ourProps:he,theirProps:h,slot:xe,defaultTag:ms,name:"Switch"}))}let hs=ze(xs),ps=us,fe=Object.assign(hs,{Group:ps,Label:ss,Description:$e});function fs({show:s,children:a,afterLeave:t,onClose:n=()=>{}}){return e.jsx(pe,{appear:!0,show:s,as:j.Fragment,afterLeave:t,children:e.jsxs(Fe,{as:"div",className:"relative z-50 w-full h-full ",onClose:n,tabIndex:1,children:[e.jsx(pe.Child,{as:j.Fragment,enter:"ease-out duration-300",enterFrom:"bg-overlay opacity-0",enterTo:"bg-overlay opacity-80",leave:"ease-in duration-200",leaveFrom:"bg-overlay opacity-80",leaveTo:"bg-overlay opacity-0",children:e.jsx("div",{className:"fixed inset-0"})}),e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(pe.Child,{as:j.Fragment,enter:"ease-out duration-300",enterFrom:"translate-x-[100%]",enterTo:"translate-x-0",leave:"ease-in duration-200",leaveFrom:"translate-x-0",leaveTo:"translate-x-[100%]",children:a})})]})})}function js(){const s=W(t=>t.environment),a=s.isInitial&&s.isDefault;return e.jsxs("div",{className:"flex flex-col pb-2 w-full",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"flex items-center text-xl px-6 font-bold whitespace-nowrap",children:[e.jsx("span",{children:"Target Environment is"}),e.jsx("span",{className:"block ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:s.name})]}),e.jsx("div",{className:"px-6",children:e.jsx(Je,{})})]}),e.jsx("div",{className:"w-full h-full overflow-auto scrollbar scrollbar--vertical px-4 py-2",children:a&&e.jsx(z,{variant:g.Warning,children:e.jsx(R,{defaultOpen:!1,children:({open:t})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(z.Headline,{className:"w-full mr-2 text-sm !mb-0",children:"Initializing Prod Environment"}),e.jsx(R.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:t?e.jsx(de,{className:"h-6 w-6 text-warning-500"}):e.jsx(ue,{className:"h-6 w-6 text-warning-500"})})]}),e.jsx(R.Panel,{className:"px-4 pb-2 text-sm mt-2",children:e.jsx(z.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})})})]})}function gs(s=0){return j.useCallback(a=>{setTimeout(()=>{a==null||a.focus()},s)},[s])}function vs(){const{start:s,end:a,skip_backfill:t,no_gaps:n,no_auto_categorization:l,forward_only:i,restate_models:u,include_unmodified:r}=$(),c=W(x=>x.environment);return e.jsx("div",{className:"w-full flex px-4 py-2",children:e.jsxs("p",{className:"ml-2 text-xs",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:c.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),e.jsxs("span",{className:"inline-block mr-1",children:["from"," ",e.jsx("b",{children:E(ne(s))?s:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till ",e.jsx("b",{children:E(ne(s))?a:"today"})]}),n&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),t&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),i&&e.jsxs("span",{className:"inline-block mr-1",children:["consider as a ",e.jsx("b",{children:"Breaking Change"})]}),l&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),E(ne(u))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate the followingmodels ",e.jsx("b",{children:u})]}),r&&e.jsx("span",{className:"inline-block mr-1",children:"with views for all models"})]})})}function bs({run:s,apply:a,cancel:t,reset:n,close:l,planAction:i}){const u=gs();function r(o){o.stopPropagation(),l()}function c(o){o.stopPropagation(),n()}function x(o){o.stopPropagation(),t()}function h(o){o.stopPropagation(),a()}function d(o){o.stopPropagation(),s()}return e.jsxs("div",{children:[e.jsx(vs,{}),e.jsx(L,{}),e.jsxs("div",{className:"flex justify-between px-4 py-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(i.isRun||i.isRunning)&&e.jsx(Q,{disabled:i.isRunning,onClick:d,ref:u,variant:g.Primary,autoFocus:!0,children:e.jsx("span",{children:A.getActionDisplayName(i,[P.RunningTask,P.Running,P.Run])})}),(i.isApply||i.isApplying)&&e.jsx(Q,{onClick:h,disabled:i.isApplying,ref:u,variant:g.Primary,children:A.getActionDisplayName(i,[P.Applying,P.ApplyBackfill,P.ApplyVirtual,P.ApplyChangesAndBackfill,P.ApplyChanges,P.ApplyMetadata],"Apply")}),i.isProcessing&&e.jsx(Q,{onClick:x,variant:g.Danger,className:"justify-self-end",disabled:i.isCancelling,children:A.getActionDisplayName(i,[P.Cancelling],"Cancel")})]}),e.jsxs("div",{className:"flex items-center",children:[[i.isProcessing,i.isRun].every(E)&&e.jsx(Q,{onClick:c,variant:g.Neutral,disabled:Qe([P.Running,P.Applying,P.Cancelling],i.value),children:A.getActionDisplayName(i,[],"Start Over")}),e.jsx(Q,{onClick:r,variant:i.isDone?g.Primary:g.Neutral,ref:i.isDone||i.isApplying?u:void 0,children:A.getActionDisplayName(i,[P.Done],"Close")})]})]})]})}function ys({label:s,enabled:a,setEnabled:t,a11yTitle:n,size:l=k.md,disabled:i=!1,className:u}){return e.jsxs(fe.Group,{as:"div",className:"flex items-center m-1",children:[e.jsxs(fe,{checked:i?!1:a,onChange:t,className:v("flex relative border-secondary-30 rounded-full m-0","shrink-0 focus:outline-none ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","transition duration-200 ease-in-out",a?"bg-secondary-500":"bg-secondary-20",u,i?"opacity-50 cursor-not-allowed":"cursor-pointer",l===k.sm&&"h-[14px] w-6 focus:ring-1 border",l===k.md&&"h-5 w-10 focus:ring-2 border-2",l===k.lg&&"h-7 w-14 focus:ring-4 border-2"),disabled:i,children:[e.jsx("span",{className:"sr-only",children:n}),e.jsx("span",{"aria-hidden":"true",className:v("pointer-events-none inline-block transform rounded-full shadow-md transition duration-200 ease-in-out","bg-light",l===k.sm&&"h-3 w-3",l===k.md&&"h-4 w-4",l===k.lg&&"h-6 w-6",a&&l===k.sm&&"translate-x-[10px]",a&&l===k.md&&"translate-x-5",a&&l===k.lg&&"translate-x-7")})]}),s!=null&&e.jsx(fe.Label,{className:v("text-xs font-light ml-1 text-neutral-600 dark:text-neutral-400"),children:s})]})}function V({label:s,info:a,enabled:t,disabled:n=!1,setEnabled:l,className:i}){return e.jsxs("div",{className:v("flex justify-between",i),children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[s,e.jsx("small",{className:"block text-xs text-neutral-500",children:a})]}),e.jsx(ys,{disabled:n,enabled:t,setEnabled:l,size:k.lg})]})}function ws({disabled:s=!1}){const a=ve(),{start:t,end:n,isInitialPlanRun:l}=$();return e.jsxs("div",{className:"flex w-full flex-wrap md:flex-nowrap",children:[e.jsx(O,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",disabled:s||l,children:({disabled:i,className:u})=>e.jsx(O.Textfield,{className:v(u,"w-full"),disabled:i,placeholder:"2023-12-13",value:t,onInput:r=>{r.stopPropagation(),a({type:D.DateStart,start:r.target.value})}})}),e.jsx(O,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",disabled:s||l,children:({disabled:i,className:u})=>e.jsx(O.Textfield,{className:v(u,"w-full"),disabled:i,placeholder:"2022-12-13",value:n,onInput:r=>{r.stopPropagation(),a({type:D.DateEnd,end:r.target.value})}})})]})}function Ns(){const s=ve(),{skip_tests:a,no_gaps:t,skip_backfill:n,forward_only:l,auto_apply:i,no_auto_categorization:u,restate_models:r,isInitialPlanRun:c,create_from:x,include_unmodified:h}=$(),d=W(b=>b.environment),o=W(b=>b.environments),m=Ne.getOnlySynchronized(Array.from(o));return e.jsxs("form",{className:"w-full h-full",children:[e.jsxs("fieldset",{className:v("mb-10 mt-6"),children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1 px-4",children:"Set Dates"}),e.jsx("div",{className:"mt-3",children:e.jsx(ws,{})})]}),e.jsx("fieldset",{className:v("mb-4 mt-6"),children:e.jsx(R,{children:({open:b})=>e.jsxs(e.Fragment,{children:[e.jsxs(R.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Additional Options"}),b?e.jsx(de,{className:"h-6 w-6 text-primary-500"}):e.jsx(ue,{className:"h-6 w-6 text-primary-500"})]}),e.jsxs(R.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:[e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[E(d.isDefault)&&e.jsx(O,{className:"w-full",label:"Create From Environment",info:"The environment to base the plan on rather than local files",disabled:m.length<2,children:({className:p,disabled:T})=>e.jsx(O.Selector,{className:v(p,"w-full"),list:Ne.getOnlySynchronized(Array.from(o)).map(F=>({value:F.name,text:F.name})),onChange:F=>{s({type:D.PlanOptions,create_from:F})},value:x,disabled:T})}),e.jsx(O,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
                    downstream from the one specified. For production
                    environment, all related model versions will have
                    their intervals wiped, but only the current
                    versions will be backfilled. For development
                    environment, only the current model versions will
                    be affected`,children:({className:p})=>e.jsx(O.Textfield,{className:v(p,"w-full"),placeholder:"project.model1, project.model2",disabled:c,value:r??"",onInput:T=>{T.stopPropagation(),s({type:D.PlanOptions,restate_models:T.target.value})}})})]})}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap w-full mt-3",children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(V,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
              are defined`,enabled:a,setEnabled:p=>{s({type:D.PlanOptions,skip_tests:p})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(V,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
              comparing to existing snapshots for matching
              models in the target environment`,enabled:t||n&&d.isDefaultInitial||d.isDefaultInitial,disabled:c||n&&d.isDefaultInitial||d.isDefaultInitial,setEnabled:p=>{s({type:D.PlanOptions,no_gaps:p})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(V,{label:"Skip Backfill",info:"Skip the backfill step",enabled:n,disabled:c||d.isDefaultInitial,setEnabled:p=>{s({type:D.PlanOptions,skip_backfill:p})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsxs("div",{className:"block my-2",children:[e.jsx(V,{label:"Include Unmodified",info:"Indicates whether to create views for all models in the target development environment or only for modified ones",enabled:h,disabled:c||d.isDefaultInitial,setEnabled:p=>{s({type:D.PlanOptions,include_unmodified:p})}}),e.jsx(V,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:l,disabled:c||d.isDefaultInitial,setEnabled:p=>{s({type:D.PlanOptions,forward_only:p})}})]}),e.jsx("div",{className:"block my-2",children:e.jsx(V,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:i,setEnabled:p=>{s({type:D.PlanOptions,auto_apply:p})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(V,{label:"No Auto Categorization",info:"Set category manually",enabled:u,disabled:c||d.isDefaultInitial,setEnabled:p=>{s({type:D.PlanOptions,no_auto_categorization:p})}})})]})]})]})]})})})]})}function ks({environment:s,isInitialPlanRun:a}){const{start:t,end:n,skip_tests:l,no_gaps:i,skip_backfill:u,forward_only:r,no_auto_categorization:c,restate_models:x,create_from:h,include_unmodified:d}=$(),o=j.useMemo(()=>{if(!s.isDefault)return{start:t,end:a&&ne(x)?void 0:n}},[s,t,n,a,x]);return{planOptions:j.useMemo(()=>s.isDefaultInitial?{skip_tests:l,include_unmodified:!0}:{no_gaps:i,skip_backfill:u,forward_only:r,create_from:h,no_auto_categorization:c,skip_tests:l,restate_models:x,include_unmodified:d},[s,i,u,r,d,h,c,l,x]),planDates:o}}function Ps({isInitialPlanRun:s}){const{start:a,end:t,skip_tests:n,no_gaps:l,skip_backfill:i,forward_only:u,include_unmodified:r,no_auto_categorization:c,restate_models:x,create_from:h,change_categorization:d}=$(),o=j.useMemo(()=>{if(!s)return{start:a,end:t}},[a,t,s]),m=j.useMemo(()=>Array.from(d.values()).reduce((b,{category:p,change:T})=>(b[T.model_name]=p.value,b),{}),[d]);return{planDates:o,planOptions:{no_gaps:l,skip_backfill:i,forward_only:u,include_unmodified:r,create_from:h,no_auto_categorization:c,skip_tests:n,restate_models:x},categories:m}}function Be(s,a){const t=s.isFinished&&(a.isLatest||a.isRunning)&&w(s.overview),n=t?s.overview:a,l=t?s:a;return{meta:l.meta,start:l.start,end:l.end,hasChanges:n.hasChanges,hasBackfills:n.hasBackfills,changes:l.changes,backfills:l.backfills,validation:l.validation,plan_options:l.plan_options}}const De=3;function Y({progress:s=0,delay:a=0,duration:t=0,startFromZero:n=!0,className:l}){return E(n)&&(s=s<De?De:s),e.jsx("div",{className:v("w-full h-1 bg-neutral-30 overflow-hidden flex items-center rounded-lg my-1",l),children:e.jsx("div",{className:"transition-[width] h-full bg-success-500 rounded-lg",style:{width:`${s}%`,transitionDelay:`${a}ms`,transitionDuration:`${t}ms`}})})}const f=function({children:a,setRefTasksOverview:t,tasks:n}){const{models:l,taskCompleted:i,taskTotal:u,batchesTotal:r,batchesCompleted:c}=j.useMemo(()=>{const x=Object.entries(n),h=x.length;let d=0,o=0,m=0;return x.forEach(([b,{completed:p,total:T}])=>{d=p===T?d+1:d,o+=T,m+=p}),{models:x,taskCompleted:d,taskTotal:h,batchesTotal:o,batchesCompleted:m}},[n]);return e.jsx("div",{className:"text-prose",ref:t,children:a({models:l,completed:i,total:u,totalBatches:r,completedBatches:c})})};function Ts({className:s,headline:a,environment:t,completed:n,total:l,updatedAt:i,updateType:u,completedBatches:r,totalBatches:c}){return e.jsx(ye,{className:s,children:e.jsxs(le,{children:[e.jsxs(ie,{children:[e.jsx(re,{children:e.jsx(Oe,{headline:a,environment:t})}),e.jsxs(oe,{children:[e.jsx(J,{completed:n,total:l,unit:"task"}),e.jsx(ee,{}),e.jsx(J,{completed:r,total:c,unit:"batches"}),e.jsx(ee,{}),e.jsx(ce,{completed:r,total:c})]})]}),e.jsx(Y,{progress:q(r,c)}),i!=null&&e.jsx(Cs,{updatedAt:i,updateType:u})]})})}function Ds({models:s,className:a,changes:t,showBatches:n=!0,showProgress:l=!0,showVirtualUpdate:i=!1,queue:u}){const{changesAdded:r,changesRemoved:c,changesModifiedDirect:x,changesModifiedIndirect:h}=j.useMemo(()=>{const o=t==null?void 0:t.modified;return{changesAdded:(t==null?void 0:t.added)??[],changesRemoved:(t==null?void 0:t.removed)??[],changesModifiedMetadata:(o==null?void 0:o.metadata)??[],changesModifiedIndirect:((o==null?void 0:o.indirect)??[]).map(({model_name:m})=>m),changesModifiedDirect:((o==null?void 0:o.direct)??[]).map(({model_name:m})=>m)}},[t]),d=j.useMemo(()=>M(u)?[]:s.filter(([o])=>u.includes(o)),[u,s]);return e.jsxs(e.Fragment,{children:[U(u)&&e.jsxs("div",{className:"p-4 mt-6 shadow-lg bg-neutral-5 rounded-lg",children:[e.jsx(K,{text:"Currently in proccess"}),e.jsx(je,{models:d,children:([o,m])=>e.jsxs(le,{children:[e.jsxs(ie,{children:[e.jsxs(re,{children:[w(m.interval)&&e.jsx(Ce,{start:m.interval[0],end:m.interval[1]}),e.jsx(_e,{modelName:o,changeType:Ee({modelName:o,changesAdded:r,changesRemoved:c,changesModifiedDirect:x,changesModifiedIndirect:h})})]}),e.jsxs(oe,{children:[n&&e.jsx(J,{completed:m.completed,total:m.total,unit:"batch"}),e.jsx(ee,{}),l&&e.jsx(e.Fragment,{children:M(m.end)||M(m.start)?e.jsx(ce,{total:m.total,completed:m.completed}):e.jsx(Se,{start:m.start,end:m.end})}),i&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),l?e.jsx(Y,{startFromZero:!1,progress:q(m.completed,m.total)}):e.jsx(L,{className:"my-1 border-neutral-200 opacity-50"})]})})]}),e.jsx(ye,{className:a,children:e.jsx(je,{models:s,children:([o,m])=>e.jsxs(le,{children:[e.jsxs(ie,{children:[e.jsxs(re,{children:[w(m.interval)&&e.jsx(Ce,{start:m.interval[0],end:m.interval[1]}),e.jsx(_e,{modelName:o,changeType:Ee({modelName:o,changesAdded:r,changesRemoved:c,changesModifiedDirect:x,changesModifiedIndirect:h})})]}),e.jsxs(oe,{children:[n&&e.jsx(J,{completed:m.completed,total:m.total,unit:"batch"}),e.jsx(ee,{}),l&&e.jsx(e.Fragment,{children:M(m.end)||M(m.start)?e.jsx(ce,{total:m.total,completed:m.completed}):e.jsx(Se,{start:m.start,end:m.end})}),i&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),l?e.jsx(Y,{progress:q(m.completed,m.total),startFromZero:d.findIndex(([b])=>b===o)===-1}):e.jsx(L,{className:"my-1 border-neutral-200 opacity-50"})]})})})]})}function ye({className:s,children:a}){return e.jsx("div",{className:v("my-3 max-h-[50vh] overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a})}function le({className:s,children:a}){return e.jsx("div",{className:v("px-2",s),children:a})}function je({className:s,models:a,children:t}){return e.jsx("ul",{className:v("rounded-lg py-4 overflow-auto text-prose hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a.map(([n,l])=>e.jsx("li",{className:"mb-2",children:t([n,l])},n))})}function ie({className:s,children:a}){return e.jsx("div",{className:v("flex sm:justify-between sm:items-baseline text-xs",s),children:a})}function Oe({className:s,headline:a,environment:t}){return e.jsxs("span",{className:v("flex items-center",s),children:[e.jsx("span",{className:"block whitespace-nowrap text-sm font-medium",children:a}),w(t)&&e.jsx("small",{className:"inline-block ml-1 px-2 py-[0.125rem] text-xs font-bold bg-neutral-10 rounded-md",children:t})]})}function re({className:s,children:a}){return e.jsx("div",{className:v("flex mr-6 w-full sm:w-auto overflow-hidden",s),children:a})}function oe({className:s,children:a}){return e.jsx("div",{className:v("flex items-center",s),children:a})}function Ce({className:s,start:a,end:t}){return e.jsxs("span",{className:v("inline-block mr-2 whitespace-nowrap font-mono",s),children:[a," – ",t]})}function J({className:s,total:a,completed:t,unit:n}){return e.jsxs("span",{className:v("inline-block whitespace-nowrap",s),children:[t," of ",a," ",es(n,a)]})}function ee({className:s}){return e.jsx("span",{className:v("inline-block mx-2",s),children:"|"})}function ce({className:s,total:a,completed:t}){return e.jsxs("span",{className:v("inline-block whitespace-nowrap font-bold",s),children:[Math.ceil(q(t,a)),"%"]})}function Se({className:s,start:a,end:t}){return e.jsx("span",{className:v("inline-block whitespace-nowrap font-bold",s),children:`${Math.floor((t-a)/6e4)}:${String(Math.ceil((t-a)/1e3%60)).padStart(2,"0")}`})}function Cs({updateType:s,updatedAt:a}){return e.jsxs("div",{className:"flex justify-between mt-1",children:[e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Update Type:"}),e.jsx("span",{className:"inline-block ml-1",children:s})]}),e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Last Update:"}),e.jsx("span",{className:"inline-block ml-1",children:X(new Date(a),"yyyy-mm-dd hh-mm-ss",!1)})]})]})}function _e({className:s,modelName:a,changeType:t}){return e.jsx("span",{className:v("font-bold whitespace-nowrap",t===N.Add&&"text-success-600  dark:text-success-500",t===N.Remove&&"text-danger-500",t===N.Direct&&"text-secondary-500 dark:text-primary-500",t===N.Indirect&&"text-warning-500",t===N.Default&&"text-prose",s),children:a})}f.Block=ye;f.Summary=Ts;f.Details=Ds;f.DetailsProgress=oe;f.Task=le;f.Tasks=je;f.TaskDetails=ie;f.TaskProgress=ce;f.TaskSize=J;f.TaskDivider=ee;f.TaskInfo=re;f.TaskHeadline=Oe;function Ee({modelName:s,changesAdded:a,changesRemoved:t,changesModifiedDirect:n,changesModifiedIndirect:l}){return a.includes(s)?N.Add:t.includes(s)?N.Remove:n.includes(s)?N.Direct:l.includes(s)?N.Indirect:N.Default}function Ss({report:s}){var a;return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",s.total]}),e.jsxs("p",{children:["Succeeded: ",s.successful]}),e.jsxs("p",{children:["Failed: ",s.failures]}),e.jsxs("p",{children:["Errors: ",s.errors]}),e.jsxs("p",{children:["Dialect: ",s.dialect]})]}),e.jsx("ul",{children:(a=s.details)==null?void 0:a.map(t=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"—"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:t.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:t.details})})]})]},t.message))})]})}function _s(){var T,F;const s=Ie(S=>S.tests),a=I(S=>S.planApply),t=I(S=>S.planOverview),n=I(S=>S.planAction),{meta:l,start:i,end:u,hasChanges:r,hasBackfills:c,changes:x,backfills:h,validation:d,plan_options:o}=Be(a,t),m=w(s)&&!!s.total,b=w(s)&&!!s.message,p=w(s)&&!!s.failures;return e.jsxs("div",{className:"py-4",children:[w(i)&&w(u)&&e.jsxs("div",{className:"flex justify-between items-center mb-4 whitespace-nowrap",children:[e.jsxs("small",{className:"text-neutral-500 block px-4",children:["Start Date: ",e.jsx("b",{children:X(new Date(i))})]}),e.jsx(L,{}),e.jsxs("small",{className:"text-neutral-500 block px-4",children:["End Date: ",e.jsx("b",{children:X(new Date(u))})]})]}),n.isRunning||G(r)?e.jsx(Es,{report:x??{meta:l??{status:ke.init}}}):e.jsx(te,{variant:g.Info,className:"mt-2",children:"No Changes"}),n.isRunning||G(c)?e.jsx(Rs,{report:h??{meta:l??{status:ke.init}}}):e.jsx(te,{variant:g.Info,className:"mt-2",children:"No Backfills"}),G(o==null?void 0:o.skip_tests)?e.jsx(te,{variant:g.Info,className:"mt-2",children:"Tests Skipped"}):e.jsxs(e.Fragment,{children:[b&&e.jsx(Fs,{report:s}),m&&e.jsx(Is,{report:s})]}),w(d)&&e.jsx(As,{report:d}),n.isApplyVirtual&&e.jsx(Gs,{isUpdated:G((F=(T=a.promote)==null?void 0:T.meta)==null?void 0:F.done)}),p||a.shouldShowEvaluation&&e.jsxs(Ms,{start:a.evaluationStart,end:a.evaluationEnd,children:[w(a.creation)&&e.jsx(Bs,{report:a.creation}),w(a.restate)?e.jsx(Os,{report:a.restate}):e.jsx(te,{variant:g.Info,className:"mt-2",children:"No Models To Restate"}),w(a.backfill)&&w(a.environment)&&e.jsx(zs,{backfill:a.backfill,backfills:h,isVirtualUpdate:n.isApplyVirtual,environment:a.environment}),w(a.promote)&&e.jsx($s,{report:a.promote})]})]})}function Es({report:s,isOpen:a=!1}){return e.jsx(B,{meta:s.meta,states:["Changes Collected","Failed Getting Plan Changes","Getting Plan Changes..."],isOpen:a,panel:e.jsx(Vs,{})})}function Rs({report:s,isOpen:a=!1}){var t,n;return e.jsx(B,{meta:s.meta,states:["Backfills Collected","Failed Getting Plan Backfills","Getting Plan Backfills..."],isOpen:a,panel:e.jsx(_,{headline:`Models ${((t=s.models)==null?void 0:t.length)??0}`,type:N.Default,children:e.jsx(_.Default,{type:N.Default,changes:((n=s==null?void 0:s.models)==null?void 0:n.map(({model_name:l})=>l))??[]})})})}function Fs({report:s}){return e.jsx(B,{meta:{status:"success",...s},trigger:e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-6 mr-4"}),e.jsx(K,{text:"Tests Completed",size:k.sm,variant:g.Success,className:"w-full"})]}),children:e.jsx("p",{className:"mb-0.5",children:s.message})})}function Is({report:s}){return e.jsx(B,{variant:g.Danger,meta:{status:"fail",...s},trigger:e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-6 mr-4"}),e.jsx(K,{text:"Tests Failed",size:k.sm,variant:g.Danger,className:"w-full"})]}),children:e.jsx(Ss,{report:s})})}function As({report:s}){return e.jsx(B,{meta:s.meta,states:["Plan Validated","Plan Validation Failed","Validating Plan..."],showDetails:!1})}function Ms({start:s,end:a,children:t}){const n=j.useRef(null);return j.useEffect(()=>{requestAnimationFrame(()=>{var l;(l=n.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})})},[]),e.jsxs("div",{ref:n,className:"pt-6 pb-2",children:[w(s)&&e.jsxs(e.Fragment,{children:[e.jsxs("small",{className:"text-neutral-500 block px-4 mb-1",children:["Evaluation started at"," ",e.jsx("b",{children:X(new Date(s),"yyyy-mm-dd hh-mm-ss")})]}),e.jsx(L,{}),e.jsx("small",{className:"text-neutral-500 block px-4 mt-1",children:"Given a plan, it pushes snapshots into the state and then kicks off the backfill process for all affected snapshots. Once backfill is done, snapshots that are part of the plan are promoted in the environment targeted by this plan."})]}),e.jsx("div",{className:"py-2",children:t}),w(a)&&e.jsxs(e.Fragment,{children:[e.jsx(L,{}),e.jsxs("small",{className:"text-neutral-500 block px-4 mt-1",children:["Evaluation stopped at"," ",e.jsx("b",{children:X(new Date(a),"yyyy-mm-dd hh-mm-ss")})]})]})]})}function Bs({report:s,isOpen:a}){return e.jsx(B,{meta:s.meta,states:["Snapshot Tables Created","Snapshot Tables Creation Failed","Creating Snapshot Tables..."],isOpen:a,children:w(s.total_tasks)&&e.jsx(f.Block,{children:e.jsxs(f.Task,{children:[e.jsxs(f.TaskDetails,{children:[e.jsx(f.TaskInfo,{children:e.jsx(f.TaskHeadline,{headline:"Snapshot Tables"})}),e.jsxs(f.DetailsProgress,{children:[e.jsx(f.TaskSize,{completed:s.total_tasks,total:s.num_tasks,unit:"task"}),e.jsx(f.TaskDivider,{}),e.jsx(f.TaskProgress,{completed:s.num_tasks,total:s.total_tasks})]})]}),e.jsx(Y,{progress:q(s.num_tasks,s.total_tasks)})]})})})}function Os({report:s}){return e.jsx(B,{meta:s.meta,states:["Restate Models","Restate Models Failed","Restating Models..."]})}function zs({environment:s,backfill:a,isVirtualUpdate:t,backfills:n}){const{change_categorization:l}=$(),i=j.useMemo(()=>Array.from(l.values()).reduce((r,{category:c,change:x})=>{var h;return(h=x==null?void 0:x.indirect)==null||h.forEach(d=>{var o;M(r[d])&&(r[d]=[]),(o=r[d])==null||o.push(c.value!==Pe.NUMBER_1)}),c.value===Pe.NUMBER_3&&(r[x.model_name]=[!0]),r},{}),[l]),u=j.useMemo(()=>{var r;return((r=n==null?void 0:n.models)==null?void 0:r.reduce((c,x)=>{var p;const h=x.model_name??x.view_name,d=x.interval,o={completed:0,total:x.batches,interval:d,view_name:x.view_name,...(p=a==null?void 0:a.tasks)==null?void 0:p[h]},m=i[h];return(M(m)?!1:m.every(Boolean))||(c[h]=o),c},{}))??{}},[a,n,l]);return e.jsx(B,{meta:a.meta,states:["Intervals Backfilled","Intervals Backfilling Failed","Backfilling Intervals..."],showDetails:!0,isOpen:!0,children:e.jsx(f,{tasks:u,children:({total:r,completed:c,models:x,completedBatches:h,totalBatches:d})=>e.jsxs(e.Fragment,{children:[e.jsx(f.Summary,{environment:s,headline:"Target Environment",completed:c,total:r,completedBatches:h,totalBatches:d,updateType:t?"Virtual":"Backfill"}),w(x)&&e.jsx(f.Details,{models:x,queue:a.queue,showBatches:!0,showVirtualUpdate:t,showProgress:!0})]})})})}function $s({report:s}){const a=j.useRef(null);return j.useEffect(()=>{requestAnimationFrame(()=>{var t;(t=a.current)==null||t.scrollIntoView({behavior:"smooth",block:"start"})})},[]),e.jsx("div",{ref:a,children:e.jsx(B,{meta:s.meta,states:["Environment Promoted","Promotion Failed","Promoting Environment..."],children:e.jsx(f.Block,{children:e.jsxs(f.Task,{children:[e.jsxs(f.TaskDetails,{children:[e.jsx(f.TaskInfo,{children:e.jsx(f.TaskHeadline,{headline:`Promote Environment: ${s.target_environment}`})}),e.jsxs(f.DetailsProgress,{children:[e.jsx(f.TaskSize,{completed:s.total_tasks,total:s.num_tasks,unit:"task"}),e.jsx(f.TaskDivider,{}),e.jsx(f.TaskProgress,{completed:s.num_tasks,total:s.total_tasks})]})]}),e.jsx(Y,{progress:q(s.num_tasks,s.total_tasks)})]})})})})}function Vs(){const s=I(c=>c.planOverview),a=I(c=>c.planApply),t=I(c=>c.planAction),{hasChanges:n,changes:l}=Be(a,s),{added:i=[],removed:u=[],modified:r={}}=l??{};return e.jsxs("div",{className:"w-full my-2",children:[t.isRunning&&e.jsx(z,{isFull:!0,isCenter:!0,children:e.jsx(ge,{text:"Checking Models...",hasSpinner:!0,size:k.lg})}),E(n)&&E(t.isRunning)&&e.jsx(z,{isFull:E(t.isApplyVirtual),isCenter:E(t.isApplyVirtual),children:e.jsx(K,{size:t.isApplyVirtual?k.md:k.lg,text:"No Changes"})}),G(n)&&E(t.isRunning)&&e.jsxs(e.Fragment,{children:[U(i)&&e.jsx(_,{className:"w-full my-2",headline:"Added Models",type:N.Add,children:e.jsx(_.Default,{type:N.Add,changes:i})}),U(u)&&e.jsx(_,{className:"w-full my-2",headline:"Removed Models",type:N.Remove,children:e.jsx(_.Default,{type:N.Remove,changes:u})}),U(r==null?void 0:r.direct)&&e.jsx(_,{className:"my-2 w-full",headline:"Modified Directly",type:N.Direct,children:e.jsx(_.Direct,{changes:r.direct??[]})}),U(r==null?void 0:r.indirect)&&e.jsx(_,{className:"my-2 w-full",headline:"Modified Indirectly",type:N.Indirect,children:e.jsx(_.Indirect,{changes:r.indirect??[]})}),U(r==null?void 0:r.metadata)&&e.jsx(_,{className:"my-2 w-full",headline:"Modified Metadata",type:N.Default,children:e.jsx(_.Default,{type:N.Default,changes:(r==null?void 0:r.metadata)??[]})})]})]})}function Gs({isUpdated:s=!1}){const{virtualUpdateDescription:a}=$();return e.jsx(R,{children:({open:t})=>e.jsxs(e.Fragment,{children:[e.jsxs(z,{className:"my-2 flex items-center",variant:s?g.Success:g.Info,children:[e.jsxs(e.Fragment,{children:[s&&e.jsx(me,{className:"w-6 mr-4"}),e.jsx(K,{className:"w-full",text:s?"Virtual Update Completed":"Virtual Update",size:k.sm,variant:s?g.Success:g.Info})]}),e.jsx("div",{className:"flex items-center",children:e.jsx(R.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:t?e.jsx(de,{className:"w-5"}):e.jsx(ue,{className:"w-5"})})})]}),e.jsx(R.Panel,{className:"px-2 text-xs",children:e.jsx("div",{className:"p-4 rounded-md bg-neutral-5",children:a})})]})})}function te({hasSpinner:s=!1,variant:a=g.Primary,index:t,children:n,className:l}){return e.jsx(z,{className:l,variant:a,children:e.jsxs("span",{className:"flex items-center w-full",children:[w(t)&&e.jsxs("span",{className:"inline-block mr-3 font-black whitespace-nowrap",children:["Stage ",t,":"]}),s&&e.jsx(Ae,{className:"w-4 h-4 mr-2"}),n]})})}function B({meta:s,states:a=["Success","Failed","Running"],isOpen:t=!1,trigger:n,panel:l,children:i,showDetails:u=!0}){const r=s.status==="success"?g.Success:s.status==="fail"?g.Danger:g.Info,[c,x,h]=a,d=s.status==="success"?c:s.status==="fail"?x:h;return e.jsx(R,{defaultOpen:t,children:({open:o})=>e.jsxs(e.Fragment,{children:[e.jsxs(z,{className:"my-2 flex items-center",variant:r,children:[M(n)?e.jsxs(e.Fragment,{children:[s.status==="success"&&e.jsx(me,{className:"w-6 mr-4"}),s.status==="fail"&&e.jsx(cs,{className:"w-6 mr-4"}),s.status==="init"?e.jsx(ge,{text:d,hasSpinner:!0,size:k.sm,variant:g.Primary,className:"w-full"}):e.jsxs("span",{className:"flex w-full items-baseline",children:[e.jsx(K,{text:d,size:k.sm,variant:r}),w(s.duration)&&e.jsxs("p",{className:"text-xs text-neutral-400 inline-block ml-2",children:["in ",e.jsx("b",{children:s.duration/1e3})," seconds"]})]})]}):n,u&&e.jsx("div",{className:"flex items-center",children:e.jsx(R.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:o?e.jsx(de,{className:"w-5"}):e.jsx(ue,{className:"w-5"})})})]}),e.jsxs(R.Panel,{className:"px-2 text-xs",children:[w(i)&&e.jsx("div",{className:v("p-4 rounded-md",r===g.Danger?"bg-danger-10 text-danger-500":"bg-neutral-5"),children:i}),s.status!=="fail"&&l]})]})})}function Ls({environment:s,onClose:a}){const t=ve(),{removeError:n}=Me(),{auto_apply:l}=$(),i=I(y=>y.planOverview),u=I(y=>y.planApply),r=I(y=>y.planAction),c=I(y=>y.setPlanAction),x=Ie(y=>y.setTests),h=M(s==null?void 0:s.isDefault)||G(s==null?void 0:s.isDefault),d=ks({environment:s,isInitialPlanRun:h}),o=Ps({isInitialPlanRun:h}),{refetch:m,cancel:b}=We(s.name,d),{refetch:p,cancel:T}=Xe(s.name,o),{refetch:F}=Ye();j.useEffect(()=>{w(i.environment)&&i.environment!==s.name&&(c(new A({value:P.Run})),Z())},[i,s]);function S(){t([{type:D.ResetPlanOptions}])}function Z(){u.reset(),S(),c(new A({value:P.Run}))}function xe(){n(Te.RunPlan),n(Te.ApplyPlan),S(),a()}function he(){t([{type:D.ResetTestsReport}]),c(new A({value:P.Cancelling}));let y;r.isApplying?y=b:y=T,y(),F().then(()=>{c(new A({value:P.Run}))}).catch(()=>{Z()})}function se(){t([{type:D.ResetTestsReport}]),p().catch(console.log)}function C(){x(void 0),i.reset(),u.reset(),t([{type:D.ResetTestsReport}]),m().then(({data:y})=>{t([{type:D.Dates,start:y==null?void 0:y.start,end:y==null?void 0:y.end}]),l&&se()})}return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden",children:[e.jsx(js,{}),e.jsx("div",{className:"w-full h-full px-4 overflow-y-scroll hover:scrollbar scrollbar--vertical",children:r.isCancelling?e.jsx(Us,{}):r.isRun?e.jsx(Ns,{}):e.jsx(_s,{})}),e.jsx(L,{}),e.jsx(bs,{planAction:r,apply:se,run:C,cancel:he,close:xe,reset:Z})]})}function Us(){return e.jsx("div",{className:"w-full h-full p-4",children:e.jsx("div",{className:"w-full h-full flex justify-center items-center p-4 bg-warning-10 rounded-lg overflow-hidden",children:e.jsxs(ge,{className:"inline-block",children:[e.jsx(Ae,{variant:g.Warning,className:"w-3 h-3 border border-neutral-10 mr-4"}),e.jsx("h3",{className:"text-2xl text-warning-500 font-bold",children:"Cancelling Plan..."})]})})})}const aa=j.memo(function(){const{isPlanOpen:a,setIsPlanOpen:t}=Me(),n=W(c=>c.environment),[l,i]=j.useState(!1);function u(){i(!0)}const r=G(a)&&E(l);return e.jsx(fs,{show:r,afterLeave:()=>{i(!1),t(!1)},children:e.jsx(Fe.Panel,{className:"bg-theme border-8 border-r-0 border-secondary-10 dark:border-primary-10 absolute w-[90%] md:w-[75%] xl:w-[60%] h-full right-0 flex flex-col",children:e.jsx(ts,{children:e.jsx(Ls,{onClose:u,environment:n},n.name)})})})});export{aa as default};
