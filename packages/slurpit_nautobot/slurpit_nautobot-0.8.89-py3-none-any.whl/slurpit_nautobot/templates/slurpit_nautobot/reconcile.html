{# templates/slurpit_nautobot/reconcile.html #}
{% extends 'generic/object_list.html' %}
{% load buttons %}
{% load i18n %}
{% load helpers %}
{% load static %}
{% load perms %}

{% block title %}
  Reconcile
{% endblock %}

{% block header %}
  <div class="title-container px-3 pb-3">

    {# Title #}
    
    <div id="content-title">
      {% include "slurpit_nautobot/logo.html" %}
      {# Center-align title in object-edit views #}
      <h1 class="w-100" style="margin-top: 0px">Reconcile</h1>
      <style>
        h1:before {
          content: '';
        }
      </style>
      {% block subtitle %}{% endblock %}
    </div>

    {# Controls #}
    {% block controls %}{% endblock controls %}

  </div>
  <style>
    .greenLink a {
      color: #007dff !important
    }
  </style>

{% endblock header %}

{% block content %}
  <ul class="nav nav-tabs px-3">
        
    <li class="nav-item {% if request.GET.tab == 'ipam' or request.GET.tab is None %}active{% endif %}" role="presentation">
      <a class="nav-tab nav-link " href="?tab=ipam">
        IPAM {% badge ipam_count %}
      </a>
    </li>
    <li class="nav-item {% if request.GET.tab == 'interface' %}active{% endif %}" role="presentation">
      <a class="nav-tab nav-link" href="?tab=interface">
        Interfaces {% badge interface_count %}
      </a>
    </li>
    <li class="nav-item {% if request.GET.tab == 'prefix' %}active{% endif %}" role="presentation">
      <a class="nav-tab nav-link" href="?tab=prefix">
        Prefixes {% badge prefix_count %}
      </a>
    </li>
    
  </ul>

  <div class="tab-content">
    <div class="show active" irole="tabpanel" aria-labelledby="tabpanel">

        <div class="row">
          <div class="col-sm-4 col-md-3 pull-right">
            <form method="GET" id="search-form" action="#">
              {% if request.GET.tab %}
              <input type="hidden" name="tab" value="{% if request.GET.tab  %}{{request.GET.tab}}{% endif %}" />
              {% endif %}
                <div class="input-group">
                    {{ search_form.q }}
                    <span class="input-group-btn">
                        <button type="submit" class="btn btn-primary" id="search-btn">
                            <i class="mdi mdi-magnify"></i>
                        </button>
                    </span>
                </div>
            </form>
          </div>
        </div>

        <form method="post" class="form form-horizontal" id="reconcile_form">
            {% csrf_token %}
            <input type="hidden" name="action" value="accept" id="action_input" />
            <input type="hidden" name="tab" value="{{ request.GET.tab }}" id="tab_input" />
            <input type="hidden" name="return_url" value="{% if return_url %}{{ return_url }}{% else %}{{ request.path }}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}{% endif %}" />
        
            {# Object table #}

            {% if prerequisite_model %}
              {% include 'inc/missing_prerequisites.html' %}
            {% endif %}

            <!-- {% if table.paginator.num_pages > 1 %} -->
              <div id="select-all-box" class="d-none card noprint">
                <div class="form col-md-12">
                  <div class="card-body">
                    <div class="float-end">
                      
                    </div>
                    <div class="form-check">
                      <input type="checkbox" id="select-all" name="_all" class="form-check-input" />
                      <label for="select-all" class="form-check-label">
                        {% blocktrans trimmed with count=table.rows|length object_type_plural=table.data.verbose_name_plural %}
                          Select <strong>all {{ count }} {{ object_type_plural }}</strong> matching query
                        {% endblocktrans %}
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            <!-- {% endif %} -->
            
            <div class="card">
                <div class="card-body htmx-container table-responsive" id="object_list">
                  <div class="col-md-12">
                    <div class="pull-left noprint">
                      {% block bulk_buttons %}
                        <div class="" role="group">
                            <!-- <a name="sync"  class="btn btn-orange btn-sm mx-2" href="{% url 'plugins:slurpit_nautobot:import' %}"><i class="mdi mdi-sync" aria-hidden="true"></i> {% trans "Sync" %}</a> -->
                            <a class="btn btn-success btn-sm mx-2" style="margin-right: 5px;" data-toggle="modal" data-target="#acceptModal">
                                <i class="mdi mdi-check" aria-hidden="true"></i> 
                                <span id="syncCaption">{% trans "Accept" %}</span>
                            </a>
                            <a  class="btn btn-danger btn-sm" data-toggle="modal" data-target="#declineModal">
                                <i class="mdi mdi-close" aria-hidden="true"></i> {% trans "Decline" %}
                            </a>
                        </div>
                      {% endblock %}                      
                    </div>
                  </div>
      
                  {% block table %}
                    {% include "slurpit_nautobot/table.html" %}
                  {% endblock %}
      
                </div>
            </div>
        </form>
    </div>
  </div> 

  <div class="modal fade" tabindex="-1" id="acceptModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
  
        <!-- Modal Header -->
        <div class="modal-header">
          <h2 class="modal-title">Are you sure to accept the selected records?</h2>
          <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
        </div>
  
        <!-- Modal Footer -->
        <div class="modal-footer">
            <a class="btn btn-success btn-sm" id="accept_btn">{% trans "Accept" %}</a>
            <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
  </div>

  <div class="modal fade" tabindex="-1" id="declineModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
  
        <!-- Modal Header -->
        <div class="modal-header">
          <h2 class="modal-title">Are you sure to decline the selected records?</h2>
          <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
        </div>
  
        <!-- Modal Footer -->
        <div class="modal-footer">
            <a class="btn btn-danger btn-sm" id="decline_btn">{% trans "Decline" %}</a>
            <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
  </div>

  {% if request.GET.pk %}
    <div class="modal fade in" style="display: block; padding-right: 15px;" tabindex="-1" id="reconcile-detail-modal" aria-modal="true" role="dialog">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">

          <!-- Modal Header -->
          <div class="modal-header" style="display: flex;">
            <h4 class="modal-title">
              {{ title }} | {{ object_type }}|  {{ action }} 
            </h4>
            <button type="button" class="close" aria-label="Close" style="margin-left: auto">
              <!-- <a class="btn-close" href="?{% if request.GET.tab %}tab={{request.GET.tab}}{% endif %}" aria-label="Close">
                X
              </a> -->
              <a class="btn-close" aria-label="Close" id="reconcile-close">
                X
              </a>
            </button>
            
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col col-md-5">
                  <div class="panel panel-default">
                      <div class="panel-heading">
                          {% trans "Change" %}
                      </div>
                      <div class="panel-body">
                          <table class="table table-hover attr-table">
                              <tr>
                                  <th scope="row">{% trans "Time" %}</th>
                                  <td>
                                      {{ updated_time }}
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">{% trans "Action" %}</th>
                                  <td>
                                      {{ action }}
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">{% trans "Object Type" %}</th>
                                  <td>
                                      {{ object_type }}
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">{% trans "Object" %}</th>
                                  <td>
                                      {% if object and object.get_absolute_url %}
                                          {{ object }}
                                      {% endif %}
                                  </td>
                              </tr>
                          </table>
                      </div>
                  </div>
              </div>

              <div class="col col-md-7">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        {% trans "Difference" %}
                    </div>
                    <div class="panel-body">
                        {% if diff_added == diff_removed %}
                            <span class="text-muted" style="margin-left: 10px;">
                                {% if object.action == 'create' %}
                                    {% trans "Object Created" %}
                                {% elif object.action == 'delete' %}
                                    {% trans "Object Deleted" %}
                                {% else %}
                                    {% trans "No Changes" %}
                                {% endif %}
                            </span>
                        {% else %}
                            <pre class="change-diff change-removed">{{ diff_removed|render_json }}</pre>
                            <pre class="change-diff change-added">{{ diff_added|render_json }}</pre>
                        {% endif %}
                    </div>
                </div>
            </div>
            </div>

            <div class="row mb-3">
            <div class="col col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        {% trans "Current state" %}
                    </div>
                    <div class="panel-body">
                    {% if current_state %}
                      <pre>{{ current_state |render_json }}</pre>
                    {% elif non_atomic_change %}
                        {% trans "Warning: Comparing non-atomic change to previous change record" %} (<a href="{% url 'extras:objectchange' pk=prev_change.pk %}">{{ prev_change.pk }}</a>)
                    {% else %}
                        <span class="text-muted">{% trans "None" %}</span>
                    {% endif %}
                    </div>
                </div>
            </div>
            <div class="col col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        {% trans "Incomming change" %}
                    </div>
                    <div class="panel-body">
                        {% if incomming_change %}
                          <pre>{{ incomming_change |render_json }}</pre>
                        {% else %}
                            <span class="text-muted">{% trans "None" %}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            </div>
          </div>

          <!-- Modal Body -->
          
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade in"></div>
  {% endif %}


    <style>
        .footer {
        border-top-left-radius: 0px !important;
        border-top-right-radius: 0px !important;
        margin-left: 0px !important;
        margin-right: 0px !important;
        }
    </style>

    <script>
      function removeTabParameterWithoutReloading() {
        let url = new URL(window.location.href);
        url.searchParams.delete('pk');

        // Update the URL without reloading the page
        window.history.replaceState(null, '', url.href);
      }

      
      // Find the button element on the page
      var closeButton = document.getElementById('reconcile-close');

      // Define the function to be called when the button is clicked
      function handleCloseButtonClick(event) {
        
        removeTabParameterWithoutReloading();

        var backdrops = document.getElementsByClassName('modal-backdrop');
        // Loop through each backdrop element and hide it by setting its display style to 'none'
        for (var i = 0; i < backdrops.length; i++) {
          backdrops[i].style.display = 'none';
        }

        // Get the element with the 'reconcile-detail-modal' ID
          var modal = document.getElementById('reconcile-detail-modal');

        // Set its display style to 'none' to hide it
        if (modal) {
          modal.style.display = 'none';
        }
        
        // Optionally prevent the default action if needed (e.g., if the anchor navigates to a URL)
        event.preventDefault();
      }

      // Add the event listener for the 'click' event
      closeButton.addEventListener('click', handleCloseButtonClick);

        var reconcile_form = document.getElementById('reconcile_form')
        var accept_btn = document.getElementById('accept_btn')
        var decline_btn = document.getElementById('decline_btn')
        var action_input = document.getElementById('action_input')

        accept_btn.addEventListener("click", function(event) {
            action_input.value = "accept"
            reconcile_form.submit()
        });

        decline_btn.addEventListener("click", function(event) {
            action_input.value = "decline"
            reconcile_form.submit()
        });


        var searchBtn = document.getElementById("search-btn")

        var searchForm = document.getElementById("search-form")

        if(searchBtn) {
          searchBtn.addEventListener("click", function(event) {
            searchForm.submit()
          })
        }

    </script>

{% endblock content %}

<footer class="footer container-fluid">
  {% block footer %}
    <div class="row align-items-center justify-content-between mx-0">

      <div class="col-sm-12 col-md-auto fs-4 noprint">
        <nav class="nav justify-content-center justify-content-lg-start">
          {% block footer_links %}
            <a type="button" class="nav-link h6" href="https://slurpit.io" target="_blank">
              https://slurpit.io
            </a>
          {% endblock footer_links %}
        </nav>
      </div>

      <div class="col-sm-12 col-md-auto text-center text-lg-end text-muted"  >
        <span class="d-block d-md-inline">
          {% now 'T' %}
        </span>
        <span class="ms-md-3 d-block d-md-inline">{{ settings.HOSTNAME }} (v{{ settings.VERSION }})</span>
        <span class="ms-md-3 d-block d-md-inline">Slurpit(v{{ settings.PLUGINS_CONFIG.slurpit_nautobot.version }})</span>
      </div>

    </div>
    
  {% endblock footer %}
</footer>

