import {
  PartialMessage as __bufbuildProtobufPartialMessage,
{% if google_protobuf_used_messages is defined and google_protobuf_used_messages|length > 0%}
  {{ google_protobuf_used_messages|join(', \n	') }}
{% endif %}
} from "@bufbuild/protobuf";
{% if proto.messages_and_enums | length > 0 %}
import {
{% for message in proto.messages_and_enums | unique | list %}
  {% if message not in proto.states %}
  {{ message }},
  {% endif %}
{% endfor %}
} from "./{{ pb_name }}.js";
{% endif %}

{# TODO: State is currently aliased as `${state}Proto`: see #3129 #}
{% if proto.states|length > 0 %}
{% for state in proto.states %}
import {
  {{ state }} as {{ state }}Proto,
} from "./{{ pb_name }}.js";
{% endfor %}
{% endif %}

import {
  Context,
  Workflow,
  ReaderContext,
  WriterContext,
} from "@reboot-dev/resemble";
import { fileURLToPath } from "node:url";
import * as path from "node:path";

import * as resembleNative from "@reboot-dev/resemble/resemble_native.cjs";

{% if imports|length > 0 %}
// Include all transitive imports.
{% for import_path, unique_name in imports.items() %}
import * as {{ unique_name }} from "{{ import_path }}";
{% endfor %}
{% endif %}

{# Start generated Interface code #}
{% for service in services %}

export abstract class {{ service.options.proto.state_name }}Interface {
  static __rsmModule__ = "{{ rsm_name }}";
  static __servicerNodeAdaptor__ = "{{ service.options.proto.state_name }}ServicerNodeAdaptor";

  {% for method in service.methods %}
  abstract {{ method.proto.name }}(
    {% if method.options.proto.kind == 'reader'%}
    context: ReaderContext,
    {% endif %}
    {% if method.options.proto.kind == 'writer'%}
    context: WriterContext,
    {% endif %}
    {% if not (method.options.proto.kind == 'writer' and method.options.proto.constructor) %}
    state: {{ service.options.proto.state_name }}Proto,
    {% endif %}
    request: {{ method.input_type }},
  ): Promise<
  {%- if method.options.proto.kind == 'writer' -%}
  {{ service.options.proto.state_name }}.{{ method.proto.name }}.Effects
  {%- else -%}
  {{ method.output_type }} | __bufbuildProtobufPartialMessage<{{ method.output_type }}>
  {%- endif -%}
  >;

  {% endfor %}
  {% for method in service.methods %}
  async _{{ method.proto.name }}(
     {% if method.options.proto.kind == 'reader'%}
    context: ReaderContext,
    {% endif %}
    {% if method.options.proto.kind == 'writer'%}
    context: WriterContext,
    {% endif %}
    {% if not(method.options.proto.kind == 'writer' and method.options.proto.constructor) %}
    jsonState: string,
    {% endif %}
    jsonRequest: string
  ): Promise<string> {
    return JSON.stringify(
      await this.{{ method.proto.name }}(
        context,
        {% if not (method.options.proto.kind == 'writer' and method.options.proto.constructor) %}
        new {{ service.options.proto.state_name }}Proto(JSON.parse(jsonState)),
        {% endif %}
        new {{ method.input_type }}(JSON.parse(jsonRequest))
      )
    );
  }

  {% endfor %}
}
{% endfor %}
{# End generated Interface code #}
{# Start generated Service code #}
{% for service in services %}

export class {{ service.options.proto.state_name }} {
  #external;

  static Interface = {{ service.options.proto.state_name }}Interface;
  static State = {{ service.options.proto.state_name }}Proto;

  {% for method in service.methods if method.options.proto.kind == 'writer' %}

  static {{ method.proto.name }} = class {
    static Effects = class {
      state: {{ service.options.proto.state_name }}Proto;
      response: {{ method.output_type }};

      constructor(effects: {
        state: __bufbuildProtobufPartialMessage<{{ service.options.proto.state_name }}Proto>;
        response: __bufbuildProtobufPartialMessage<{{ method.output_type }}>;
      }) {
        this.state = effects.state instanceof {{
        service.options.proto.state_name }}Proto ? effects.state : new {{ service.options.proto.state_name }}Proto(effects.state);
        this.response = effects.response instanceof {{
        method.output_type }} ? effects.response : new {{ method.output_type }}(effects.response);
      }
    };
  };
  {% endfor %}

  constructor(id: string) {
    this.#external = resembleNative.Service_constructor({
      rsmModule: "{{ rsm_name }}",
      nodeAdaptor: "{{ service.options.proto.state_name }}NodeAdaptor",
      id: id,
    });
  }

  {% for method in service.methods %}
  async {{ method.proto.name }}(
    contextOrWorkflow: Context | Workflow,
    partialRequest: __bufbuildProtobufPartialMessage<{{ method.input_type }}>
  ): Promise<{{ method.output_type }}> {

    const request = partialRequest instanceof {{ method.input_type }} ?
    partialRequest : new {{ method.input_type }}(partialRequest);

    return new {{ method.output_type }}(
      JSON.parse(
        await resembleNative.Service_call({
          external: this.#external,
          kind: "{{ method.options.proto.kind }}",
          method: "{{ method.proto.name }}",
          requestModule: "{{ pb2_name }}",
          requestType: "{{ method.input_type }}",
          contextOrWorkflow: contextOrWorkflow.external(),
          jsonRequest: JSON.stringify(request),
        })
      )
    );
  }

  {% endfor %}
}

{% for method in service.methods if method.options.proto.kind == 'writer' %}
export namespace {{ service.options.proto.state_name }}.{{ method.proto.name }} {
  export type Effects = typeof {{ service.options.proto.state_name }}.{{ method.proto.name }}.Effects.prototype;
}
{% endfor %}

{% endfor %}
{# End generated Service code #}

resembleNative.importPy("{{ pb2_name }}", "{{ base64_gzip_pb2_py }}");
resembleNative.importPy("{{ pb2_grpc_name }}", "{{ base64_gzip_pb2_grpc_py }}");
resembleNative.importPy("{{ rsm_name }}", "{{ base64_gzip_rsm_py }}");
